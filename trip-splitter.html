<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>旅行清算アプリ</title>
<style>
  * { box-sizing: border-box; }
  :root{--gap:12px;--radius:10px}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.4;margin:0;background:#0b1020;color:#eef0f6}
  header{padding:16px 20px;border-bottom:1px solid #223}
  h1{font-size:20px;margin:0}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  @media(max-width:900px){.wrap{grid-template-columns:1fr}}
  .card{background:#121833;border:1px solid #1e2646;border-radius:var(--radius);padding:16px}
  .card h2{font-size:16px;margin:0 0 8px 0}
  label{display:block;font-size:13px;margin-top:10px;opacity:.9}
  input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2a376a;background:#0f1530;color:#eef0f6;font-size:16px;}
  input[type="checkbox"]{width:auto;margin-right:8px}
  .row{display:flex;gap:var(--gap)}
  .row > *{flex:1}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a376a;background:#0f1530;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:13px}
  .chips{margin-top:6px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill.plus{background:#123d28;border:1px solid #1c6b42;color:#a9f3c8}
  .pill.minus{background:#3a1820;border:1px solid #7e3340;color:#ffc7d0}
  table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
  th,td{border-bottom:1px solid #223;padding:8px;text-align:left;vertical-align:top;word-wrap:break-word}
  .right{text-align:right}
  .muted{opacity:.8}
  .btn{cursor:pointer}
  .btn.secondary{background:#0f1530;border-color:#2a376a}
  .btn.danger{background:#2a0f18;border-color:#6a2a3a}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media(max-width:780px){.grid{grid-template-columns:1fr}}
  .small{font-size:12px}
  .editing-mode input { border-color: #4a5c9a; background: #1a2240; }
  .editing-mode #addTxBtn { background: #2a376a; border-color: #4a5c9a; }
  input:focus::placeholder, textarea:focus::placeholder{ opacity: 0; }

  /* タブ（Excelシート風） */
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
    margin:0 0 12px 0;
  }
  .tabbtn{
    width:auto; padding:8px 12px;
    border-radius:999px;
    border:1px solid #2a376a;
    background:#0f1530;
    cursor:pointer;
    font-size:13px;
    opacity:.9;
  }
  .tabbtn.active{
    background:#1a2240;
    border-color:#4a5c9a;
    opacity:1;
  }
  .tabpane{display:none}
  .tabpane.active{display:block}

  /* モーダル共通 */
  .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999;}
  .modal .panel{
    max-width:560px; width:92vw; margin:10vh auto;
    background:#121833; border:1px solid #2a376a; border-radius:12px; padding:14px;
  }

  /* ギャンブル入力行 */
  .gRow{
    display:grid;
    grid-template-columns: 1fr 110px 160px;
    gap:10px;
    align-items:center;
    padding:6px 0;
    border-bottom:1px solid #223;
  }
  .signBtn{
    width:auto; padding:8px 10px; border-radius:10px;
    border:1px solid #2a376a; background:#0f1530;
    cursor:pointer; font-size:14px;
  }
  .signBtn.plus{ border-color:#1c6b42; background:#123d28; color:#a9f3c8; }
  .signBtn.minus{ border-color:#7e3340; background:#3a1820; color:#ffc7d0; }
  .gName{font-size:14px}

  .deltaBox{
    margin-top:10px;
    padding:8px 10px;
    border:1px solid #223;
    border-radius:10px;
    background:#0f1530;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
</style>
</head>
<body>
<header>
  <h1>旅行清算アプリ</h1>
</header>

<div class="wrap">
  <aside class="card">
    <h2>新規作成</h2>
    <div class="row" style="margin-top:10px">
      <input id="newTripName" placeholder="新しい旅行" />
      <button class="btn" id="createTripBtn">作成</button>
    </div>
    <hr style="border-color:#223;margin:14px 0" />

    <h2>旅行選択</h2>
    <select id="tripSelect"></select>
    <button class="btn secondary small" id="renameTripBtn" style="margin-top:8px">旅行名を変更</button>

    <hr style="border-color:#223;margin:14px 0" />
    <h2>メンバー</h2>
    <div class="row">
      <input id="memberName" placeholder="名前" />
      <button class="btn" id="addMemberBtn">追加</button>
    </div>
    <div id="members" class="chips"></div>
    <hr style="border-color:#223;margin:14px 0" />
    <button class="btn danger" id="deleteTripBtn" style="margin-top:8px">この旅行を削除</button>
  </aside>

  <main>
    <!-- タブ -->
    <div class="tabs">
      <button class="tabbtn active" id="tabExpenseBtn">支出を追加</button>
      <button class="tabbtn" id="tabGambleBtn">ギャンブル精算</button>
    </div>

    <!-- ===== タブ1: 支出を追加 ===== -->
    <section class="tabpane active" id="tabExpense">
      <section class="card" id="txFormCard">
        <h2 id="formTitle">支出を追加</h2>

        <div class="grid">
          <div>
            <label for="txDesc">説明</label>
            <input id="txDesc" placeholder="例：銭湯、宿代、ジュース など" />
          </div>
        </div>

        <div class="grid" style="margin-top:10px">
          <div>
            <label for="txAmount">金額（円）</label>
            <input id="txAmount" type="text" inputmode="decimal" placeholder="例：6500" />
          </div>

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <label style="margin:0;">支払者（複数可） <span class="muted small">※空欄は均等割り</span></label>
              <button class="btn secondary small" id="editPayerAmountsBtn" style="width:auto;padding:4px 10px">個別金額を指定</button>
            </div>
            <div id="payers" class="chips"></div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <label style="margin:0;">サービスを受けた人 <span class="muted small">※空欄は均等割り</span></label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              <button class="btn secondary small" id="selectAllBenBtn" style="width:auto;padding:4px 10px">全員選択</button>
              <button class="btn secondary small" id="editBenAmountsBtn" style="width:auto;padding:4px 10px">個別金額を指定</button>
            </div>
          </div>
          <div id="beneficiaries" class="chips"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="addTxBtn">支出を追加</button>
          <button class="btn secondary" id="clearFormBtn">入力クリア</button>
        </div>
      </section>
    </section>

    <!-- ===== タブ2: ギャンブル精算 ===== -->
    <section class="tabpane" id="tabGamble">
      <section class="card" id="gambleCard">
        <h2>ギャンブル精算</h2>

        <div class="grid">
          <div>
            <label for="gDesc">説明</label>
            <input id="gDesc" placeholder="例：麻雀1回目 / ルーレット など" />
          </div>
        </div>

        <div style="margin-top:10px" class="muted small">
          各メンバーの金額を入力し、勝ちは「＋」負けは「−」にしてください（合計が0円になる必要があります）。
        </div>

        <!-- ずれ表示 -->
        <div class="deltaBox">
          <div>合計（＋/−）のずれ：</div>
          <div id="gDelta" style="font-weight:700;">0円</div>
        </div>

        <div id="gList" style="margin-top:10px;"></div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="addGambleBtn">精算結果を追加</button>
          <button class="btn secondary" id="clearGambleBtn">入力クリア</button>
        </div>
      </section>
    </section>

    <!-- ===== 結果（既存結果 + ギャンブル結果を下に追加） ===== -->
    <section class="card">
      <h2>結果</h2>
      <table id="resultTable">
        <thead>
          <tr><th>名前</th><th class="right">使用額</th><th class="right">支払額</th><th class="right">勝敗</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:14px">
        <div style="font-size:14px;font-weight:600;">ギャンブル結果（現在の収支）</div>
        <table id="gambleBalanceTable">
          <thead>
            <tr><th>名前</th><th class="right">収支</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>支出一覧</h2>
      <table id="txTable">
        <thead>
          <tr><th>説明</th><th class="right">金額</th><th>支払者</th><th>恩恵者</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>
</div>

<!-- 恩恵者モーダル（ボタン押下時のみ表示） -->
<div id="benModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-size:16px; font-weight:600;">（恩恵者）個別金額を指定</div>
      <button class="btn secondary small" id="benModalCloseBtn" style="width:auto;">閉じる</button>
    </div>
    <div class="muted small" style="margin-top:8px;">
      チェックされている人だけ表示されます（「経済」も含む）。空欄は「均等割り」扱い。
    </div>
    <div id="benModalList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;"></div>
    <div class="row" style="margin-top:12px;">
      <button class="btn secondary" id="benModalClearBtn">入力をクリア</button>
      <button class="btn" id="benModalSaveBtn">反映</button>
    </div>
  </div>
</div>

<!-- 支払者モーダル（ボタン押下時のみ表示） -->
<div id="payModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-size:16px; font-weight:600;">（支払者）個別金額を指定</div>
      <button class="btn secondary small" id="payModalCloseBtn" style="width:auto;">閉じる</button>
    </div>
    <div class="muted small" style="margin-top:8px;">
      チェックされている人だけ表示されます。空欄は「均等割り」扱い。
    </div>
    <div id="payModalList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;"></div>
    <div class="row" style="margin-top:12px;">
      <button class="btn secondary" id="payModalClearBtn">入力をクリア</button>
      <button class="btn" id="payModalSaveBtn">反映</button>
    </div>
  </div>
</div>

<!-- ギャンブル精算ポップアップ -->
<div id="settleModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-size:16px; font-weight:600;">ギャンブル精算結果</div>
      <!-- 右上の閉じるボタンは置かない -->
    </div>

    <div class="muted small" style="margin-top:8px;">
      「保存して閉じる」で反映／「キャンセル」で前の画面に戻ります。
    </div>

    <div id="settleList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>

    <div class="row" style="margin-top:12px;">
      <button class="btn secondary" id="settleCancelBtn">キャンセル</button>
      <button class="btn" id="settleSaveBtn">保存して閉じる</button>
    </div>
  </div>
</div>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, setDoc, updateDoc, deleteDoc, doc,
  onSnapshot, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDgHVdhx0RwTv6PkzBBNgY8Ouis7yRGwlY",
  authDomain: "trip-app-eb508.firebaseapp.com",
  projectId: "trip-app-eb508",
  storageBucket: "trip-app-eb508.firebasestorage.app",
  messagingSenderId: "38650349203",
  appId: "1:38650349203:web:1987ddb1536bca9bbe6f66",
  measurementId: "G-JBSHND42QP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ECON = "経済";

// ユーティリティ
const byId=id=>document.getElementById(id);
const yen=n=>Math.round(n||0).toLocaleString();
const escapeHtml=s=>String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
const uuid=()=>crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2));
function toInt(v){
  if(v==null) return 0;
  const n = String(v).replace(/[^\d-]/g,"");
  return Number.parseInt(n,10) || 0;
}
function openModal(el){ el.style.display="block"; }
function closeModal(el){ el.style.display="none"; }

// ===== DOM =====
const newTripName=byId("newTripName");
const createTripBtn=byId("createTripBtn");
const tripSelect = byId("tripSelect");
const renameTripBtn = byId("renameTripBtn");
const memberName=byId("memberName");
const addMemberBtn=byId("addMemberBtn");
const membersDiv=byId("members");
const deleteTripBtn=byId("deleteTripBtn");

const tabExpenseBtn=byId("tabExpenseBtn");
const tabGambleBtn=byId("tabGambleBtn");
const tabExpense=byId("tabExpense");
const tabGamble=byId("tabGamble");

const txFormCard=byId("txFormCard");
const formTitle=byId("formTitle");
const txDesc=byId("txDesc");
const txAmount=byId("txAmount");
const payersDiv=byId("payers");
const beneficiariesDiv=byId("beneficiaries");
const addTxBtn=byId("addTxBtn");
const clearFormBtn=byId("clearFormBtn");
const selectAllBenBtn=byId("selectAllBenBtn");
const editBenAmountsBtn=byId("editBenAmountsBtn");
const editPayerAmountsBtn=byId("editPayerAmountsBtn");

const benModal=byId("benModal");
const benModalList=byId("benModalList");
const benModalCloseBtn=byId("benModalCloseBtn");
const benModalSaveBtn=byId("benModalSaveBtn");
const benModalClearBtn=byId("benModalClearBtn");

const payModal=byId("payModal");
const payModalList=byId("payModalList");
const payModalCloseBtn=byId("payModalCloseBtn");
const payModalSaveBtn=byId("payModalSaveBtn");
const payModalClearBtn=byId("payModalClearBtn");

const txTableBody=document.querySelector("#txTable tbody");
const resultBody=document.querySelector("#resultTable tbody");

// ギャンブル結果（収支）
const gambleBalanceBody=document.querySelector("#gambleBalanceTable tbody");

// ギャンブルUI
const gDesc=byId("gDesc");
const gList=byId("gList");
const addGambleBtn=byId("addGambleBtn");
const clearGambleBtn=byId("clearGambleBtn");
const gDelta=byId("gDelta");

// ギャンブル精算モーダル
const settleModal = byId("settleModal");
const settleList  = byId("settleList");
const settleCancelBtn = byId("settleCancelBtn");
const settleSaveBtn   = byId("settleSaveBtn");



// Firestore 状態
let tripsUnsub=null, currentTripUnsub=null;
let tripsIndex=[], currentTripId=null, currentTripData=null;
let editingTxId = null;

// ギャンブル保存待ち（モーダルで確定するまで保持）
let pendingGambleRecord = null;

// ===== 初期化 =====
init();
function init(){
  subscribeTrips();
  bindTabs();
}
function bindTabs(){
  tabExpenseBtn.addEventListener("click", ()=> setTab("expense"));
  tabGambleBtn.addEventListener("click", ()=> setTab("gamble"));
}
function setTab(kind){
  const isExpense = kind==="expense";
  tabExpenseBtn.classList.toggle("active", isExpense);
  tabGambleBtn.classList.toggle("active", !isExpense);
  tabExpense.classList.toggle("active", isExpense);
  tabGamble.classList.toggle("active", !isExpense);
}

// ===== 旅行一覧購読 =====
tripSelect?.addEventListener("change", ()=>{ if(tripSelect.value) selectTrip(tripSelect.value); });

function subscribeTrips(){
  if(tripsUnsub) tripsUnsub();
  const q=query(collection(db,"trips"),orderBy("createdAt","asc"));
  tripsUnsub=onSnapshot(q,snap=>{
    tripsIndex=snap.docs.map(d=>({id:d.id,name:d.data().name||"(無題)"}));
    renderTripSelect();
    if(!currentTripId && tripsIndex[0]) selectTrip(tripsIndex[0].id);
    else if(currentTripId && !tripsIndex.find(t=>t.id===currentTripId)){
      currentTripId=null;
      if(tripsIndex[0]) selectTrip(tripsIndex[0].id);
      else clearMainViews();
    }
  });
}

function renderTripSelect(){
  const prev = tripSelect.value;
  tripSelect.innerHTML="";
  tripsIndex.forEach(t=>{
    const opt=document.createElement("option");
    opt.value=t.id; opt.textContent=t.name||"(無題)";
    tripSelect.appendChild(opt);
  });
  const target = tripsIndex.find(t=>t.id===currentTripId)?.id
              || tripsIndex.find(t=>t.id===prev)?.id
              || (tripsIndex[0]?.id || "");
  if(target){
    tripSelect.value=target;
    if(!currentTripId || currentTripId!==target) selectTrip(target);
  }
}

function selectTrip(id){
  currentTripId=id;
  clearForm();
  clearGambleForm();
  subscribeCurrentTrip(id);
}

function subscribeCurrentTrip(id){
  if(currentTripUnsub) currentTripUnsub();
  const ref=doc(db,"trips",id);
  currentTripUnsub=onSnapshot(ref,d=>{
    if(!d.exists()){ currentTripData=null; clearMainViews(); return; }
    currentTripData=d.data();
    // 互換：古い旅行に gambleBalance がない場合
    if(!currentTripData.gambleBalance) currentTripData.gambleBalance = {};
    if(!currentTripData.gamble) currentTripData.gamble = [];

    renderMembers();
    renderPayerAndBen();
    renderTx();
    renderResults();
    renderGambleForm();
    renderGambleBalance();
  });
}

function clearMainViews(){
  membersDiv.innerHTML=""; payersDiv.innerHTML=""; beneficiariesDiv.innerHTML="";
  txTableBody.innerHTML=""; resultBody.innerHTML="";
  gambleBalanceBody.innerHTML="";
  gList.innerHTML="";
}

// ===== メンバー表示 =====
function renderMembers(){
  membersDiv.innerHTML="";
  (currentTripData.members||[]).forEach(m=>{
    const span=document.createElement("span");
    span.className="chip"; span.textContent=m+" ";
    const x=document.createElement("button");
    x.textContent="×"; x.className="btn small"; x.style.width="auto";
    x.onclick=()=> removeMember(m);
    span.appendChild(x);
    membersDiv.appendChild(span);
  });
}

// ===== 支払者・恩恵者 =====
function renderPayerAndBen(){
  const state={payers:[], bens:[]};
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked) state.payers.push({name:cb.value, amount:cb.dataset.amount});
  });
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked) state.bens.push({name:cb.value, amount:cb.dataset.amount});
  });

  // 支払者：メンバーのみ（経済なし）
  payersDiv.innerHTML="";
  (currentTripData.members||[]).forEach(name=>{
    const label=document.createElement("label"); label.className="chip";
    const cb=document.createElement("input");
    cb.type="checkbox"; cb.value=name; cb.checked=false; cb.dataset.amount="";
    cb.addEventListener("change", ()=>{ if(!cb.checked) cb.dataset.amount=""; });
    label.appendChild(cb); label.append(" "+name);
    payersDiv.appendChild(label);
  });

  // 恩恵者：メンバー + 経済
  beneficiariesDiv.innerHTML="";
  const benList=[...(currentTripData.members||[]), ECON];
  benList.forEach(name=>{
    const label=document.createElement("label"); label.className="chip";
    const cb=document.createElement("input");
    cb.type="checkbox"; cb.value=name; cb.checked=false; cb.dataset.amount="";
    cb.addEventListener("change", ()=>{ if(!cb.checked) cb.dataset.amount=""; });
    label.appendChild(cb); label.append(" "+name);
    beneficiariesDiv.appendChild(label);
  });

  const isInit = (state.payers.length===0 && state.bens.length===0 && !editingTxId);
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(isInit){ cb.checked=false; cb.dataset.amount=""; return; }
    const hit=state.payers.find(x=>x.name===cb.value);
    cb.checked=!!hit;
    cb.dataset.amount = hit?.amount ? String(toInt(hit.amount)) : "";
  });
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(isInit){ cb.checked=false; cb.dataset.amount=""; return; }
    const hit=state.bens.find(x=>x.name===cb.value);
    cb.checked=!!hit;
    cb.dataset.amount = hit?.amount ? String(toInt(hit.amount)) : "";
  });
}

// ===== 支出一覧 =====
function renderTx(){
  const tx=[...(currentTripData.tx||[])].reverse();
  txTableBody.innerHTML="";
  tx.forEach(t=>{
    const payers = t.payers && t.payers.length ? t.payers : (t.payer ? [t.payer] : []);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHtml(t.desc||"")}</td>
      <td class="right">${yen(t.amount)}</td>
      <td>${payers.join(", ")}</td>
      <td>${(t.ben||[]).join(", ")}</td>
      <td>
        <div style="display:flex;gap:4px;justify-content:flex-end">
           <button class="btn small secondary" data-edit="${t.id}">編集</button>
           <button class="btn small danger" data-del="${t.id}">削除</button>
        </div>
      </td>
    `;
    txTableBody.appendChild(tr);
  });

  txTableBody.onclick=e=>{
    const delBtn=e.target.closest("button[data-del]");
    if(delBtn) deleteTx(delBtn.dataset.del);
    const editBtn=e.target.closest("button[data-edit]");
    if(editBtn) startEditTx(editBtn.dataset.edit);
  };
}

// ===== 結果 =====
function renderResults(){
  const members=currentTripData.members||[];
  const tx=currentTripData.tx||[];

  const fair=Object.fromEntries(members.map(m=>[m,0]));
  const paid=Object.fromEntries(members.map(m=>[m,0]));

  for(const t of tx){
    const amount=Number(t.amount)||0;

    // 支払者（固定額→残り均等割り）
    const payers = (t.payers && t.payers.length) ? t.payers.filter(p=>members.includes(p))
                  : (t.payer ? [t.payer] : []);
    if(payers.length===0) continue;

    const payerAmounts=t.payerAmounts||{};
    let sumFixedPay=0;
    const fixedPayers=[];
    for(const p of payers){
      const v=payerAmounts?.[p];
      if(v){
        paid[p]=(paid[p]||0)+Number(v);
        sumFixedPay+=Number(v);
        fixedPayers.push(p);
      }
    }
    const remainPay=amount-sumFixedPay;
    const othersPay=payers.filter(p=>!fixedPayers.includes(p));
    const sharePay=othersPay.length ? remainPay/othersPay.length : 0;
    for(const p of othersPay) paid[p]=(paid[p]||0)+sharePay;

    // 恩恵者（経済は集計対象外）
    const benMembers=(t.ben||[]).filter(b=>members.includes(b));
    if(benMembers.length){
      let sumFixedBen=0;
      const fixedTargets=[];
      for(const b of benMembers){
        const val=t.benAmounts?.[b];
        if(val){
          fair[b]=(fair[b]||0)+Number(val);
          sumFixedBen+=Number(val);
          fixedTargets.push(b);
        }
      }
      const remainBen=amount-sumFixedBen;
      const othersBen=benMembers.filter(b=>!fixedTargets.includes(b));
      const shareBen=othersBen.length ? remainBen/othersBen.length : 0;
      for(const b of othersBen) fair[b]=(fair[b]||0)+shareBen;
    }
  }

  resultBody.innerHTML="";
  members.forEach(m=>{
    const f=Math.round(fair[m]||0);
    const p=Math.round(paid[m]||0);
    const d=f-p;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${m}</td>
      <td class="right">${yen(f)}</td>
      <td class="right">${yen(p)}</td>
      <td class="right"><span class="pill ${d>=0?"plus":"minus"}">${d>=0?"+":""}${yen(d)}</span></td>`;
    resultBody.appendChild(tr);
  });
}

// ===== ギャンブル入力フォーム描画 =====
function renderGambleForm(){
  const members=currentTripData.members||[];
  gList.innerHTML="";

  const head=document.createElement("div");
  head.className="gRow";
  head.style.fontWeight="600";
  head.style.opacity=".9";
  head.innerHTML=`<div>名前</div><div>勝敗</div><div>金額</div>`;
  gList.appendChild(head);

  members.forEach(name=>{
    const row=document.createElement("div");
    row.className="gRow";

    const nameDiv=document.createElement("div");
    nameDiv.className="gName";
    nameDiv.textContent=name;

    const signBtn=document.createElement("button");
    signBtn.type="button";
    signBtn.className="signBtn plus";
    signBtn.textContent="＋（勝）";
    signBtn.dataset.sign="+";
    signBtn.addEventListener("click", ()=>{
      const s=signBtn.dataset.sign==="+" ? "-" : "+";
      signBtn.dataset.sign=s;
      signBtn.classList.toggle("plus", s==="+");
      signBtn.classList.toggle("minus", s==="-");
      signBtn.textContent = (s==="+") ? "＋（勝）" : "−（負）";
      updateGambleDelta();
    });

    const amount=document.createElement("input");
    amount.type="text";
    amount.inputMode="decimal";
    amount.placeholder="例：1000";
    amount.dataset.name=name;
    amount.addEventListener("input", updateGambleDelta);

    row.appendChild(nameDiv);
    row.appendChild(signBtn);
    row.appendChild(amount);
    gList.appendChild(row);
  });

  updateGambleDelta();
}

function clearGambleForm(){
  gDesc.value="";
  if(gList) {
    gList.querySelectorAll('input[data-name]').forEach(inp=> inp.value="");
    gList.querySelectorAll('button.signBtn').forEach(btn=>{
      btn.dataset.sign="+";
      btn.classList.add("plus"); btn.classList.remove("minus");
      btn.textContent="＋（勝）";
    });
  }
  updateGambleDelta();
}
clearGambleBtn?.addEventListener("click", clearGambleForm);

function readGambleEntries(){
  const members = currentTripData?.members || [];
  const entries = {};
  let sum = 0;

  const rows = [...gList.querySelectorAll(".gRow")].slice(1);
  rows.forEach(r=>{
    const inp = r.querySelector('input[data-name]');
    const btn = r.querySelector('button.signBtn');
    if(!inp || !btn) return;

    const name = inp.dataset.name;
    const abs = toInt(inp.value);
    const sign = btn.dataset.sign || "+";
    const val = (sign === "-" ? -abs : abs);

    entries[name] = val;
    sum += val;
  });

  const cleaned = {};
  members.forEach(m => cleaned[m] = Number(entries[m] || 0));
  return { entries: cleaned, sum };
}

function updateGambleDelta(){
  if(!gDelta || !currentTripData) return;
  const { sum } = readGambleEntries();
  // sum が 0 なら OK。ズレは sum のまま表示。
  const v = sum;
  const pillClass = (v===0) ? "plus" : (v>0 ? "plus" : "minus");
  gDelta.innerHTML = `<span class="pill ${pillClass}">${v>=0?"+":""}${yen(v)}円</span>`;
}

// ===== ギャンブル精算（ポップアップ表示） =====
addGambleBtn?.addEventListener("click", ()=>{
  if(!currentTripData || !currentTripId) return;

  const members=currentTripData.members||[];
  const desc=(gDesc.value||"").trim() || "（無題）";

  const { entries, sum } = readGambleEntries();

  if(Object.values(entries).every(v=>v===0)){
    alert("1人以上、金額を入力してください");
    return;
  }
  if(sum!==0){
    alert(`合計が0円ではありません（現在：${yen(sum)}円）。勝ち（＋）と負け（−）の合計が0になるように入力してください。`);
    return;
  }

  const transfers = computeTransfers(entries, members);

  settleList.innerHTML="";
  if(transfers.length===0){
    const div=document.createElement("div");
    div.className="muted";
    div.textContent="支払いは発生しません。";
    settleList.appendChild(div);
  } else {
    transfers.forEach(t=>{
      const div=document.createElement("div");
      div.innerHTML = `<span class="pill minus">${escapeHtml(t.from)}</span> → <span class="pill plus">${escapeHtml(t.to)}</span>　<span style="font-weight:600">${yen(t.amount)}円</span>`;
      settleList.appendChild(div);
    });
  }

  pendingGambleRecord = {
    id: uuid(),
    desc,
    entries,
    transfers
  };

  openModal(settleModal);
});

// ===== ギャンブル精算モーダル操作 =====

// 「キャンセル」＝保存せず戻る
settleCancelBtn?.addEventListener("click", ()=>{
  pendingGambleRecord = null;
  closeModal(settleModal);
});

// 背景クリックでもキャンセル扱いで戻る（不要ならこのブロックを消してOK）
settleModal?.addEventListener("click", (e)=>{
  if(e.target === settleModal){
    pendingGambleRecord = null;
    closeModal(settleModal);
  }
});


settleSaveBtn?.addEventListener("click", async ()=>{
  if(!pendingGambleRecord || !currentTripData || !currentTripId) return;

  // 1) ギャンブル結果の「現在の収支」に加算
  const members = currentTripData.members || [];
  const curBal = {...(currentTripData.gambleBalance||{})};
  members.forEach(m => { if(curBal[m]==null) curBal[m]=0; });

  for(const m of members){
    curBal[m] = Number(curBal[m]||0) + Number(pendingGambleRecord.entries?.[m]||0);
  }

  // 2) 支出一覧（tx）へ「誰が誰にいくら」形式で追加
  //   例：A→B 100円 なら 支払者A, 恩恵者B, 金額100
  const txList = [...(currentTripData.tx||[])];

  for(const tr of (pendingGambleRecord.transfers||[])){
    if(!tr.amount || tr.amount<=0) continue;
    txList.push({
      id: uuid(),
      desc: `（ギャンブル）${pendingGambleRecord.desc}`,
      amount: Number(tr.amount),
      payers: [tr.from],
      payer: tr.from,
      payerAmounts: {}, // 使わない
      ben: [tr.to],
      benAmounts: {}    // 使わない（1対1なので均等でも同じ）
    });
  }

  // 3) ログとして gamble も残す（任意。履歴を消したいならここは外してOK）
  const gambleLog=[...(currentTripData.gamble||[])];
  gambleLog.push(pendingGambleRecord);

  try{
    await updateDoc(doc(db,"trips",currentTripId),{
      gambleBalance: curBal,
      tx: txList,
      gamble: gambleLog
    });
    pendingGambleRecord=null;
    closeModal(settleModal);
    clearGambleForm();
    setTab("expense");
  }catch(e){
    console.error(e);
    alert("保存に失敗しました");
  }
});

// 誰→誰の支払いを作る（勝者へ、敗者から）
function computeTransfers(entries, members){
  const creditors=[]; // {name, amt}
  const debtors=[];   // {name, amt} amtは正の支払い額
  members.forEach(m=>{
    const v=Number(entries[m]||0);
    if(v>0) creditors.push({name:m, amt:v});
    else if(v<0) debtors.push({name:m, amt:-v});
  });

  const transfers=[];
  let i=0,j=0;
  while(i<debtors.length && j<creditors.length){
    const d=debtors[i];
    const c=creditors[j];
    const x=Math.min(d.amt, c.amt);
    if(x>0){
      transfers.push({from:d.name, to:c.name, amount: Math.round(x)});
      d.amt-=x;
      c.amt-=x;
    }
    if(d.amt<=0.000001) i++;
    if(c.amt<=0.000001) j++;
  }
  return transfers;
}

// ===== ギャンブル結果（現在の収支）表示 =====
function renderGambleBalance(){
  const members = currentTripData.members || [];
  const bal = currentTripData.gambleBalance || {};

  gambleBalanceBody.innerHTML="";
  members.forEach(m=>{
    const v = Math.round(Number(bal[m]||0));
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(m)}</td>
      <td class="right"><span class="pill ${v>=0?"plus":"minus"}">${v>=0?"+":""}${yen(v)}</span></td>
    `;
    gambleBalanceBody.appendChild(tr);
  });
}

// ===== 支出操作 =====
createTripBtn.addEventListener("click", async ()=>{
  const name=(newTripName.value||"").trim()||"新しい旅行";
  const ref = await addDoc(collection(db,"trips"),{
    name, members:[], tx:[], gamble:[], gambleBalance:{}, createdAt:serverTimestamp()
  });
  selectTrip(ref.id);
  newTripName.value="";
});

renameTripBtn.addEventListener("click", async ()=>{
  if(!currentTripId || !currentTripData) return;
  const curName = currentTripData.name || "";
  const newName = prompt("新しい旅行名を入力してください", curName);
  if(newName && newName !== curName) {
    await updateDoc(doc(db, "trips", currentTripId), { name: newName });
  }
});

addMemberBtn.addEventListener("click", async ()=>{
  if(!currentTripData || !currentTripId) return;
  const m=(memberName.value||"").trim();
  if(!m) return;

  const members=[...(currentTripData.members||[])];
  if(members.includes(m)) { memberName.value=""; return; }
  members.push(m);

  // tx の整合
  const tx = (currentTripData.tx||[]).map(t=>({
    ...t,
    ben: (t.ben||[]).filter(b=>members.includes(b) || b===ECON),
    payers: (t.payers|| (t.payer?[t.payer]:[])).filter(p=>members.includes(p)),
    payerAmounts: cleanMapByMembers(t.payerAmounts||{}, members),
    benAmounts: cleanMapByMembers(t.benAmounts||{}, [...members, ECON])
  }));

  // gamble の整合
  const gamble = (currentTripData.gamble||[]).map(g=>{
    const entries = cleanMapByMembers(g.entries||{}, members);
    const transfers = (g.transfers||[]).filter(t=>members.includes(t.from) && members.includes(t.to));
    return { ...g, entries, transfers };
  });

  // gambleBalance の整合
  const gambleBalance = {...(currentTripData.gambleBalance||{})};
  members.forEach(x => { if(gambleBalance[x]==null) gambleBalance[x]=0; });

  await setDoc(doc(db,"trips",currentTripId),{ ...currentTripData, members, tx, gamble, gambleBalance });
  memberName.value="";
});

deleteTripBtn.addEventListener("click", async ()=>{
  if(!currentTripId) return;
  if(!confirm("本当にこの旅行を削除しますか？")) return;
  await deleteDoc(doc(db,"trips",currentTripId));
  currentTripId=null; currentTripData=null;
  clearMainViews();
});

// 支出追加/更新
addTxBtn.addEventListener("click", async ()=>{
  if(!currentTripData || !currentTripId) return;

  const desc=(txDesc.value||"").trim();
  const amount = toInt(txAmount.value);

  // 支払者
  const payers = [];
  const payerAmounts = {};
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked){
      payers.push(cb.value);
      if(cb.dataset.amount) payerAmounts[cb.value] = toInt(cb.dataset.amount);
    }
  });

  // 恩恵者
  const ben = [];
  const benAmounts = {};
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked){
      ben.push(cb.value);
      if(cb.dataset.amount) benAmounts[cb.value] = toInt(cb.dataset.amount);
    }
  });

  if(!amount){ alert("金額は1円以上で入力してください"); return; }
  if(payers.length===0){ alert("支払者を1人以上選んでください"); return; }
  if(ben.length===0){ alert("恩恵者を1人以上選んでください"); return; }

  const sumP = Object.values(payerAmounts).reduce((a,b)=>a+(Number(b)||0),0);
  if(sumP > amount){ alert("（支払者）個別金額の合計が、支出金額を超えています。"); return; }
  const sumB = Object.values(benAmounts).reduce((a,b)=>a+(Number(b)||0),0);
  if(sumB > amount){ alert("（恩恵者）個別金額の合計が、支出金額を超えています。"); return; }

  let newTxList = [...(currentTripData.tx||[])];

  const txObj = {
    id: editingTxId || uuid(),
    desc,
    amount,
    payers,
    payer:payers[0],
    payerAmounts,
    ben,
    benAmounts
  };

  if(editingTxId) {
    const idx = newTxList.findIndex(t => t.id === editingTxId);
    if(idx !== -1) newTxList[idx] = txObj;
    else newTxList.push(txObj);
  } else {
    newTxList.push(txObj);
  }

  const isEdit = !!editingTxId;
  if(!confirm(isEdit ? "この内容で更新しますか？" : "この内容で追加しますか？")) return;

  try {
    await updateDoc(doc(db,"trips",currentTripId),{ tx: newTxList });
    clearForm();
  } catch (e) {
    console.error(e);
    alert("保存に失敗しました");
  }
});

clearFormBtn.addEventListener("click", clearForm);

async function deleteTx(id){
  if(!currentTripData || !currentTripId) return;
  if(!confirm("この支出を削除しますか？")) return;
  const tx=(currentTripData.tx||[]).filter(t=>t.id!==id);
  if(editingTxId === id) clearForm();
  await updateDoc(doc(db,"trips",currentTripId),{ tx });
}

function startEditTx(id) {
  const t = (currentTripData.tx||[]).find(x => x.id === id);
  if(!t) return;

  editingTxId = id;
  txFormCard.classList.add("editing-mode");
  formTitle.textContent = "支出を編集";
  addTxBtn.textContent = "支出を更新";
  clearFormBtn.textContent = "キャンセル";

  txDesc.value = t.desc || "";
  txAmount.value = t.amount;

  const payers = t.payers || (t.payer ? [t.payer] : []);
  const payerAmounts = t.payerAmounts || {};
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    const on = payers.includes(cb.value);
    cb.checked = on;
    cb.dataset.amount = (on && payerAmounts[cb.value]) ? String(toInt(payerAmounts[cb.value])) : "";
  });

  const bens = t.ben || [];
  const benAmounts = t.benAmounts || {};
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    const on = bens.includes(cb.value);
    cb.checked = on;
    cb.dataset.amount = (on && benAmounts[cb.value]) ? String(toInt(benAmounts[cb.value])) : "";
  });

  setTab("expense");
  txFormCard.scrollIntoView({ behavior: "smooth" });
}

async function removeMember(name){
  if(!confirm(`${name} をメンバーから削除しますか？`)) return;

  const members=(currentTripData.members||[]).filter(m=>m!==name);

  // tx
  const tx=(currentTripData.tx||[]).map(t=>{
    const payers = (t.payers || (t.payer?[t.payer]:[])).filter(p=>p!==name);
    const ben = (t.ben||[]).filter(b=>b!==name);
    const payerAmounts = {...(t.payerAmounts||{})}; delete payerAmounts[name];
    const benAmounts = {...(t.benAmounts||{})}; delete benAmounts[name];
    if(payers.length===0) return null;
    return { ...t, payers, payer:payers[0], ben, payerAmounts, benAmounts };
  }).filter(Boolean);

  // gamble log
  const gamble=(currentTripData.gamble||[]).map(g=>{
    const entries = {...(g.entries||{})};
    delete entries[name];
    const transfers = (g.transfers||[]).filter(t=>t.from!==name && t.to!==name);
    return { ...g, entries, transfers };
  });

  // gambleBalance
  const gambleBalance = {...(currentTripData.gambleBalance||{})};
  delete gambleBalance[name];

  await setDoc(doc(db,"trips",currentTripId),{ ...currentTripData, members, tx, gamble, gambleBalance });
}

// ===== 個別金額モーダル（支払者/恩恵者） =====
editBenAmountsBtn?.addEventListener("click", openBenAmountModal);
benModalCloseBtn?.addEventListener("click", ()=> closeModal(benModal));
benModal?.addEventListener("click", (e)=>{ if(e.target === benModal) closeModal(benModal); });
benModalClearBtn?.addEventListener("click", ()=>{ benModalList.querySelectorAll('input[data-name]').forEach(inp=> inp.value = ""); });
benModalSaveBtn?.addEventListener("click", saveBenAmountModal);

editPayerAmountsBtn?.addEventListener("click", openPayerAmountModal);
payModalCloseBtn?.addEventListener("click", ()=> closeModal(payModal));
payModal?.addEventListener("click", (e)=>{ if(e.target === payModal) closeModal(payModal); });
payModalClearBtn?.addEventListener("click", ()=>{ payModalList.querySelectorAll('input[data-name]').forEach(inp=> inp.value = ""); });
payModalSaveBtn?.addEventListener("click", savePayerAmountModal);

function makeAmountRow(name, cur){
  const row = document.createElement("div");
  row.style.display = "grid";
  row.style.gridTemplateColumns = "1fr 160px";
  row.style.gap = "10px";
  row.style.alignItems = "center";

  const left = document.createElement("div");
  left.textContent = name;

  const input = document.createElement("input");
  input.type = "text";
  input.inputMode = "decimal";
  input.placeholder = "空欄=均等割り";
  input.value = cur ? String(cur) : "";
  input.setAttribute("data-name", name);

  row.appendChild(left);
  row.appendChild(input);
  return row;
}

function openBenAmountModal(){
  const checked = [];
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) checked.push(cb); });
  if(checked.length === 0){ alert("まず『サービスを受けた人』を1人以上チェックしてください"); return; }
  benModalList.innerHTML = "";
  checked.forEach(cb=> benModalList.appendChild(makeAmountRow(cb.value, cb.dataset.amount || "")));
  openModal(benModal);
}
function saveBenAmountModal(){
  benModalList.querySelectorAll('input[data-name]').forEach(inp=>{
    const name = inp.dataset.name;
    const n = toInt(inp.value);
    const cb = Array.from(beneficiariesDiv.querySelectorAll('input[type="checkbox"]')).find(x => x.value === name);
    if(!cb) return;
    cb.dataset.amount = n > 0 ? String(n) : "";
  });
  closeModal(benModal);
}

function openPayerAmountModal(){
  const checked = [];
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) checked.push(cb); });
  if(checked.length === 0){ alert("まず『支払者』を1人以上チェックしてください"); return; }
  payModalList.innerHTML = "";
  checked.forEach(cb=> payModalList.appendChild(makeAmountRow(cb.value, cb.dataset.amount || "")));
  openModal(payModal);
}
function savePayerAmountModal(){
  payModalList.querySelectorAll('input[data-name]').forEach(inp=>{
    const name = inp.dataset.name;
    const n = toInt(inp.value);
    const cb = Array.from(payersDiv.querySelectorAll('input[type="checkbox"]')).find(x => x.value === name);
    if(!cb) return;
    cb.dataset.amount = n > 0 ? String(n) : "";
  });
  closeModal(payModal);
}

// 全員選択（経済は選ばない）
selectAllBenBtn?.addEventListener("click", ()=>{
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.checked = (cb.value !== ECON);
    if(!cb.checked) cb.dataset.amount = "";
  });
});

// ===== その他 =====
function cleanMapByMembers(map, allowed){
  const out={};
  Object.keys(map||{}).forEach(k=>{
    if(allowed.includes(k)) out[k]=map[k];
  });
  return out;
}

function clearForm(){
  editingTxId = null;
  txFormCard.classList.remove("editing-mode");
  formTitle.textContent = "支出を追加";
  addTxBtn.textContent = "支出を追加";
  clearFormBtn.textContent = "入力クリア";

  txDesc.value = "";
  txAmount.value = "";
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; cb.dataset.amount = ""; });
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; cb.dataset.amount = ""; });
}
</script>
</body>
</html>
