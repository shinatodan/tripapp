<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>旅行清算アプリ</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; }
  h2 { margin-top: 1.5rem; }
  .chip { display:inline-flex; align-items:center; margin:0.2rem; padding:0.3rem 0.6rem;
    border:1px solid #ccc; border-radius:9999px; cursor:pointer; user-select:none;}
  .chip input { margin-right:0.3rem; }
  .list {margin:0.5rem 0; padding:0;}
  .list li {list-style:none; border-bottom:1px solid #ddd; padding:0.3rem 0;}
  button {margin:0.2rem; padding:0.4rem 0.8rem;}
  .small { font-size:0.8em; margin-left:0.4em; color:#666;}
</style>
</head>
<body>
<h1>旅行清算アプリ</h1>

<h2>メンバー</h2>
<input id="memberName" placeholder="メンバー名"/>
<button onclick="addMember()">追加</button>
<div id="members"></div>

<h2>支出入力</h2>
<input id="txDesc" placeholder="説明"/>
<input id="txAmount" type="number" placeholder="金額"/>
<div>
  <h3>支払者</h3>
  <div id="payers"></div>
</div>
<div>
  <h3>恩恵者</h3>
  <div id="beneficiaries"></div>
</div>
<button onclick="addTx()">支出を追加</button>
<button onclick="clearForm()">入力クリア</button>

<h2>支出一覧</h2>
<ul id="txList" class="list"></ul>

<h2>精算結果</h2>
<ul id="resultList" class="list"></ul>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = { /* ←ここに自分の設定を入れてください */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const memberName = document.getElementById("memberName");
const membersDiv = document.getElementById("members");
const payersDiv = document.getElementById("payers");
const beneficiariesDiv = document.getElementById("beneficiaries");
const txDesc = document.getElementById("txDesc");
const txAmount = document.getElementById("txAmount");
const txList = document.getElementById("txList");
const resultList = document.getElementById("resultList");

let members = [];
let tx = [];

function uuid(){ return Math.random().toString(36).slice(2); }
function toInt(v){ return parseInt(v)||0; }

function renderMembers(){
  membersDiv.innerHTML="";
  payersDiv.innerHTML="";
  beneficiariesDiv.innerHTML="";
  for(const m of members){
    const chip=document.createElement("label");
    chip.className="chip";
    const cb=document.createElement("input");
    cb.type="checkbox"; cb.value=m;
    chip.appendChild(cb); chip.append(" "+m);
    payersDiv.appendChild(chip);

    const bchip=document.createElement("label");
    bchip.className="chip";
    const bcb=document.createElement("input");
    bcb.type="checkbox"; bcb.value=m; bcb.checked=true;
    bchip.appendChild(bcb); bchip.append(" "+m);
    const span=document.createElement("span");
    span.className="small"; span.textContent="均等";
    bchip.appendChild(span);

    // 長押しで個別金額入力
    let pressTimer;
    bchip.addEventListener("touchstart", e=>{
      pressTimer=setTimeout(()=>{
        const val=prompt(`${m} の金額を入力`, bcb.dataset.amount||"");
        if(val!==null){
          const num=toInt(val);
          if(num>0){
            bcb.dataset.amount=num;
            span.textContent=num+"円";
          }else{
            delete bcb.dataset.amount;
            span.textContent="均等";
          }
        }
      },600);
    },{passive:true});
    bchip.addEventListener("touchend", ()=>clearTimeout(pressTimer));

    beneficiariesDiv.appendChild(bchip);
  }
}

function addMember(){
  const n=memberName.value.trim();
  if(!n) return;
  members.push(n);
  memberName.value="";
  renderMembers();
}

async function addTx(){
  const desc=txDesc.value.trim();
  const amount=toInt(txAmount.value);
  if(!desc||amount<=0) return;
  const payers=[...payersDiv.querySelectorAll("input:checked")].map(x=>x.value);
  if(payers.length===0) return;
  const ben=[...beneficiariesDiv.querySelectorAll("input:checked")].map(x=>x.value);
  if(ben.length===0) return;

  const benAmounts={};
  for(const cb of beneficiariesDiv.querySelectorAll("input:checked")){
    if(cb.dataset.amount) benAmounts[cb.value]=toInt(cb.dataset.amount);
  }

  const item={ id:uuid(), desc, amount, payers, payer:payers[0], ben, benAmounts };
  tx.push(item);
  await addDoc(collection(db,"tx"),item);
  renderTx(); renderResults(); clearForm();
}

function renderTx(){
  txList.innerHTML="";
  for(const t of tx){
    const li=document.createElement("li");
    li.textContent=`${t.desc} : ${t.amount}円, 支払:${t.payer}, 恩恵:${t.ben.join(",")}`;
    txList.appendChild(li);
  }
}

function renderResults(){
  const paid={}, fair={};
  for(const m of members){ paid[m]=0; fair[m]=0; }
  for(const t of tx){
    const perPay=t.amount/t.payers.length;
    for(const p of t.payers){ paid[p]+=perPay; }

    const benAmts=t.benAmounts||{};
    let fixed=0; let flexible=[];
    for(const b of t.ben){
      if(benAmts[b]!=null){ fair[b]+=benAmts[b]; fixed+=benAmts[b]; }
      else flexible.push(b);
    }
    if(flexible.length>0){
      const remain=t.amount-fixed;
      const per=remain/flexible.length;
      for(const b of flexible){ fair[b]+=per; }
    }
  }
  resultList.innerHTML="";
  for(const m of members){
    const li=document.createElement("li");
    li.textContent=`${m}: 支払 ${paid[m].toFixed(0)}円, 負担 ${fair[m].toFixed(0)}円, 差額 ${(paid[m]-fair[m]).toFixed(0)}円`;
    resultList.appendChild(li);
  }
}

function clearForm(){
  txDesc.value="";
  txAmount.value="";
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.checked=true;
    delete cb.dataset.amount;
    cb.parentNode.querySelector("span").textContent="均等";
  });
}

// Firestoreから初期ロード
(async()=>{
  const snap=await getDocs(collection(db,"tx"));
  tx=snap.docs.map(d=>d.data());
  renderTx(); renderResults();
})();
</script>
</body>
</html>
