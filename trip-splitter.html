<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>旅行清算アプリ</title>
<style>
  * { box-sizing: border-box; }

  :root{
    --gap:12px;
    --radius:14px;
    --tap:48px;

    /* 追加：見分けやすさ用 */
    --bg:#0b1020;
    --card:#121833;
    --field:#0c1330;        /* 入力欄の面 */
    --field2:#0a1128;       /* さらに沈める */
    --stroke:#223;
    --stroke2:#2a376a;

    --text:#eef0f6;
    --muted:rgba(238,240,246,.82);

    --primary:#3b82f6;      /* ボタンの主色 */
    --primary2:#2563eb;
    --danger:#ef4444;
    --danger2:#dc2626;

    --ring:rgba(59,130,246,.55);
  }

  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    line-height:1.4;margin:0;background:var(--bg);color:var(--text);
    font-size:16px;
  }
  header{padding:16px 20px;border-bottom:1px solid #223}
  h1{font-size:20px;margin:0}

  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  @media(max-width:900px){.wrap{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--stroke2);border-radius:var(--radius);padding:16px}
  .card h2{font-size:16px;margin:0 0 8px 0}

  /* ===== ラベル（見やすく） ===== */
  label{
    display:block;
    font-size:13px;
    margin-top:10px;
    opacity:1;
    color:var(--muted);
    font-weight:700;
  }

  /* ===== 入力系（input/select/textarea） ===== */
  input,select,textarea{
    width:100%;
    min-height:var(--tap);
    padding:12px 12px;
    border-radius:12px;
    border:1px solid #2b3a78;
    background:linear-gradient(180deg, var(--field), var(--field2));
    color:var(--text);
    font-size:16px;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      inset 0 -1px 0 rgba(0,0,0,.35);
  }
  input::placeholder, textarea::placeholder{ color: rgba(238,240,246,.45); }

  input:focus, select:focus, textarea:focus{
    outline:none;
    border-color: rgba(59,130,246,.9);
    box-shadow:
      0 0 0 4px var(--ring),
      inset 0 1px 0 rgba(255,255,255,.06),
      inset 0 -1px 0 rgba(0,0,0,.35);
  }

  input[type="checkbox"]{width:auto;min-height:auto;margin-right:8px;box-shadow:none}

  /* 説明入力のplaceholderはフォーカスで消す */
  input:focus::placeholder, textarea:focus::placeholder { opacity: 0; }

  .row{display:flex;gap:var(--gap)}
  .row > *{flex:1}
  @media(max-width:780px){.row{flex-direction:column}.row>*{flex:unset}}

  /* ===== ボタン系（button / .btn） ===== */
  button{
    width:auto;
    min-height:var(--tap);
    padding:12px 14px;
    border-radius:14px;
    border:1px solid rgba(59,130,246,.55);
    color:var(--text);
    background:linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.95));
    font-size:16px;
    font-weight:900;
    cursor:pointer;
    box-shadow:
      0 10px 24px rgba(0,0,0,.35),
      0 2px 0 rgba(0,0,0,.25),
      inset 0 1px 0 rgba(255,255,255,.18);
    transform: translateY(0);
    transition: transform .06s ease, filter .12s ease, box-shadow .12s ease;
  }
  button:hover{ filter: brightness(1.05); }
  button:active{
    transform: translateY(1px);
    box-shadow:
      0 6px 16px rgba(0,0,0,.32),
      0 1px 0 rgba(0,0,0,.25),
      inset 0 1px 0 rgba(255,255,255,.12);
  }
  button:focus{
    outline:none;
    box-shadow:
      0 0 0 4px var(--ring),
      0 10px 24px rgba(0,0,0,.35),
      0 2px 0 rgba(0,0,0,.25),
      inset 0 1px 0 rgba(255,255,255,.18);
  }

  .btn{cursor:pointer}
  .btn.secondary, button.secondary{
    border-color: rgba(148,163,184,.35);
    background: linear-gradient(180deg, rgba(30,41,59,.95), rgba(15,23,42,.95));
    box-shadow:
      0 10px 22px rgba(0,0,0,.30),
      0 2px 0 rgba(0,0,0,.22),
      inset 0 1px 0 rgba(255,255,255,.08);
  }
  .btn.danger, button.danger{
    border-color: rgba(239,68,68,.55);
    background:linear-gradient(180deg, rgba(239,68,68,.95), rgba(220,38,38,.95));
  }

  .small{font-size:13px; font-weight:800;}
  .muted{opacity:.85}

  /* ===== チップ ===== */
  .chip{
    display:inline-flex;align-items:center;gap:6px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(15,23,42,.75);
    border-radius:999px;padding:10px 12px;margin:4px 6px 0 0;font-size:14px
  }
  .chips{margin-top:6px}

  .pill{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px}
  .pill.plus{background: rgba(16,185,129,.18); border:1px solid rgba(16,185,129,.45); color:#bff7dd}
  .pill.minus{background: rgba(244,63,94,.18); border:1px solid rgba(244,63,94,.45); color:#ffd1da}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media(max-width:780px){.grid{grid-template-columns:1fr}}

  .editing-mode input, .editing-mode select { border-color: #4a5c9a; background: #1a2240; }
  .editing-mode #addTxBtn { background: #2a376a; border-color: #4a5c9a; }

  /* タブ */
  .tabs{display:flex; gap:10px; flex-wrap:wrap; margin:0 0 12px 0;}
  .tabbtn{
    width:auto; padding:12px 14px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.28);
    background: linear-gradient(180deg, rgba(30,41,59,.7), rgba(15,23,42,.7));
    cursor:pointer;
    font-size:14px;
    min-height:var(--tap);
    font-weight:900;
  }
  .tabbtn.active{
    border-color: rgba(59,130,246,.75);
    background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.95));
    box-shadow: 0 10px 22px rgba(0,0,0,.30);
  }
  .tabpane{display:none}
  .tabpane.active{display:block}

  @media(max-width:780px){
    .tabs{position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:10}
    .tabbtn{width:calc(50% - 5px)}
    header{padding:12px 14px}
    .wrap{padding:10px;gap:10px}
    .card{padding:14px}
  }

  hr{ border-color: var(--stroke); }

  /* モーダル */
  .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999;}
  .modal .panel{
    max-width:560px; width:92vw; margin:10vh auto;
    background:var(--card); border:1px solid var(--stroke2); border-radius:14px; padding:14px;
  }

  /* ギャンブル入力行 */
  .gRow{
    display:grid;
    grid-template-columns: 1fr 110px 160px;
    gap:10px;
    align-items:center;
    padding:8px 0;
    border-bottom:1px solid #223;
  }
  @media(max-width:780px){ .gRow{grid-template-columns: 1fr 76px 1fr} }

  .signBtn{
    width:auto; padding:10px 12px; border-radius:12px;
    border:1px solid #2a376a; background:#0f1530;
    cursor:pointer; font-size:16px;
    min-height:var(--tap);
    font-weight:900;
  }
  .signBtn.plus{ border-color:#1c6b42; background:#123d28; color:#a9f3c8; }
  .signBtn.minus{ border-color:#7e3340; background:#3a1820; color:#ffc7d0; }

  .deltaBox{
    margin-top:10px;
    padding:10px 12px;
    border:1px solid #223;
    border-radius:12px;
    background:#0f1530;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  /* ===== モーダルを中でスクロールさせる（詳細結果が下で見切れない） ===== */
  .modal{
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }
  .modal .panel{
    max-height: 84vh;
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  /* body固定用 */
  body.modalOpen{
    height: 100%;
    overflow: hidden;
    touch-action: none;
  }

  /* 支出一覧ソート */
  .sortbar{
    display:flex; gap:10px; flex-wrap:wrap;
    margin-top:10px;
    align-items:center;
  }
  .sortbar select{width:auto}
  @media(max-width:780px){ .sortbar select{width:100%} }

  .wrapText{white-space:normal;overflow:visible;text-overflow:clip;word-break:break-word}
  .listCards{display:flex;flex-direction:column;gap:12px;margin-top:12px}
  .itemCard{border:1px solid #223;background:#0f1530;border-radius:16px;padding:12px}
  .itemTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .itemTitle{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-weight:700}
  .itemAmount{font-size:18px;font-weight:900}
  .itemMeta{margin-top:10px;display:grid;grid-template-columns:84px 1fr;gap:8px 10px;align-items:start;font-size:14px}
  .itemMeta .k{opacity:.85;font-weight:700}
  .itemActions{margin-top:12px;display:flex;gap:10px;flex-wrap:nowrap}
  .actionBtn{flex:1;min-height:var(--tap);border-radius:14px;font-size:16px;padding:12px 12px}
  .actionBtn.secondary{background:#121833;border-color:#2a376a}
  .actionBtn.danger{background:#2a0f18;border-color:#6a2a3a}
  .descTap{
    cursor:pointer;
    text-decoration:underline;
    text-underline-offset:3px;
    color: rgba(147,197,253,.95);
  }
  .descTap:hover{ filter: brightness(1.08); }

  .filtersGrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
  @media(max-width:780px){.filtersGrid{grid-template-columns:1fr}}

  .tableWrap{
    width:100%;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    border:1px solid rgba(148,163,184,.22);
    border-radius:14px;
    background: rgba(15,23,42,.75);
    margin-top:10px
  }
  table{width:100%;border-collapse:collapse;table-layout:auto}
  th,td{
    border-bottom:1px solid rgba(148,163,184,.18);
    padding:10px;text-align:left;vertical-align:top
  }
  .right{text-align:right}
  summary::-webkit-details-marker{display:none}

  .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  @media(max-width:480px){ .kv{grid-template-columns:1fr} }
  .miniTable{width:100%;border-collapse:collapse;border:1px solid #223;border-radius:12px;overflow:hidden;background:#0f1530}
  .miniTable th,.miniTable td{border-bottom:1px solid #223;padding:10px;font-size:14px}
  .miniTable th{opacity:.9;text-align:left}
  .miniTable td.right{text-align:right}

  /* =========================
     ★追加：左の「旅行/メンバー」パネルを折りたたみ
     ========================= */
  .tripPanel{padding:14px}
  .tripPanelHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .tripPanelTitle{
    font-size:14px;
    font-weight:800;
    opacity:.95;
  }
  .tripPanelCurrent{
    margin-top:10px;
    padding:10px 12px;
    border:1px solid #223;
    border-radius:14px;
    background:#0f1530;
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .tripPanelCurrent .name{
    font-weight:900;
    font-size:16px;
    line-height:1.3;
    word-break:break-word;
  }
  .tripPanelToggleBtn{
    width:auto;
    min-height:44px;
    padding:10px 12px;
    border-radius:999px;
    font-size:14px;
  }
  .tripPanelBody{display:none; margin-top:12px;}
  .tripPanel.open .tripPanelBody{display:block;}

  /* スマホではメインが最初に来るようにして、パネルは下に置く */
  @media(max-width:900px){
    .wrap{display:flex;flex-direction:column}
    aside{order:1}
    main{order:2}
  }

  /* =========================
     ★追加：メンバー詳細（円グラフ）モーダル
     ========================= */
  .mdTitle{font-size:16px;font-weight:800}
  .carousel{
    margin-top:12px;
    overflow-x:auto;
    display:flex;
    scroll-snap-type:x mandatory;
    gap:12px;
    -webkit-overflow-scrolling:touch;
    padding-bottom:8px;
  }
  .slide{
    scroll-snap-align:start;
    flex:0 0 100%;
    border:1px solid #223;
    background:#0f1530;
    border-radius:14px;
    padding:12px;
  }
  .slide h3{margin:0 0 10px 0;font-size:14px}
  .chartWrap{
    display:flex;
    justify-content:center;
    align-items:center;
    width:100%;
    padding:6px 0 10px 0;
  }
  canvas.pie{
    display:block;
    margin:0 auto;
    width:280px;
    height:280px;
    max-width:80vw;
    max-height:80vw;
  }
  .legend{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:10px;
  }
  .lgRow{
    display:flex; justify-content:space-between; gap:10px; align-items:center;
    padding:8px 10px;
    border:1px solid #223;
    border-radius:12px;
    background:#121833;
    font-size:14px;
  }
  .lgLeft{display:flex; align-items:center; gap:10px; min-width:0}
  .swatch{width:14px;height:14px;border-radius:4px;flex:0 0 auto}
  .lgName{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .lgVal{font-weight:800; flex:0 0 auto}
  .carCtrl{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-top:10px;
  }
  .dots{display:flex; gap:8px; justify-content:center; flex:1}
  .dot{
    width:10px; height:10px; border-radius:999px; border:1px solid #2a376a;
    background:#0f1530; cursor:pointer;
  }
  .dot.active{background:#4a5c9a}
  .navBtn{width:auto; min-height:40px; padding:8px 12px}

  /* ===== 追加：総収支の行（押せる感） ===== */
  #totalNetChips > div{
    transition: transform .08s ease, filter .12s ease;
  }
  #totalNetChips > div:hover{
    transform: translateY(-1px);
    filter: brightness(1.03);
  }
</style>
</head>

<body>
<header>
  <h1>旅行清算アプリ</h1>
</header>

<div class="wrap">

  <!-- ★折りたたみパネルに変更 -->
  <aside class="card tripPanel" id="tripPanel">
    <div class="tripPanelHeader">
      <div class="tripPanelTitle">旅行 / メンバー</div>
      <button class="btn secondary tripPanelToggleBtn" id="tripPanelToggleBtn" style="width:auto">開く</button>
    </div>

    <!-- 閉じた状態でも見える：現在の旅行名 -->
    <div class="tripPanelCurrent">
      <div class="muted" style="font-size:13px;font-weight:700">現在の旅行</div>
      <div class="name" id="currentTripNameText">（未選択）</div>
    </div>

    <!-- 折りたたみ本体（デフォルト非表示） -->
    <div class="tripPanelBody" id="tripPanelBody">
      <h2 style="margin-top:0">新規作成</h2>
      <div class="row" style="margin-top:10px">
        <input id="newTripName" placeholder="新しい旅行" />
        <button class="btn" id="createTripBtn">作成</button>
      </div>

      <hr style="border-color:#223;margin:14px 0" />

      <h2>旅行選択</h2>
      <select id="tripSelect"></select>
      <button class="btn secondary small" id="renameTripBtn" style="margin-top:8px">旅行名を変更</button>

      <hr style="border-color:#223;margin:14px 0" />

      <h2>メンバー</h2>
      <div class="row">
        <input id="memberName" placeholder="名前" />
        <button class="btn" id="addMemberBtn">追加</button>
      </div>
      <div id="members" class="chips"></div>

      <hr style="border-color:#223;margin:14px 0" />
      <button class="btn danger" id="deleteTripBtn" style="margin-top:8px">この旅行を削除</button>
    </div>
  </aside>

  <main>
    <div class="tabs">
      <button class="tabbtn active" id="tabExpenseBtn">支出を追加</button>
      <button class="tabbtn" id="tabGambleBtn">ギャンブル精算</button>
    </div>

    <!-- タブ1 -->
    <section class="tabpane active" id="tabExpense">
      <section class="card" id="txFormCard">
        <h2 id="formTitle">支出を追加</h2>

        <div class="grid">
          <div>
            <label for="txType">種類</label>
            <select id="txType">
              <option value="交通費">交通費</option>
              <option value="宿代">宿代</option>
              <option value="食費">食費</option>
              <option value="物代">物代</option>
              <option value="交際費">交際費</option>
            </select>
          </div>
          <div>
            <label for="txDesc">説明</label>
            <input id="txDesc" placeholder="例：銭湯、宿代、ジュース など" />
          </div>
        </div>

        <div class="grid" style="margin-top:10px">
          <div>
            <label for="txAmount">金額（円）</label>
            <input id="txAmount" type="text" inputmode="decimal" placeholder="例：6500" />
          </div>

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <label style="margin:0;">支払者</label>
              <button class="btn secondary small" id="editPayerAmountsBtn" style="width:auto;padding:6px 10px;min-height:40px">個別</button>
            </div>
            <div id="payers" class="chips"></div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <label style="margin:0;">サービスを受けた人</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              <button class="btn secondary small" id="selectAllBenBtn" style="width:auto;padding:6px 10px;min-height:40px">全員選択</button>
              <button class="btn secondary small" id="editBenAmountsBtn" style="width:auto;padding:6px 10px;min-height:40px">個別</button>
            </div>
          </div>
          <div id="beneficiaries" class="chips"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="addTxBtn">支出を追加</button>
          <button class="btn secondary" id="clearFormBtn">クリア</button>
        </div>
      </section>
    </section>

    <!-- タブ2 -->
    <section class="tabpane" id="tabGamble">
      <section class="card" id="gambleCard">
        <h2 id="gambleTitle">ギャンブル精算</h2>

        <div class="grid">
          <div>
            <label for="gDesc">説明</label>
            <input id="gDesc" placeholder="例：チンチロ / ビンゴ など" />
          </div>
        </div>
        <div class="deltaBox">
          <div>ズレ</div>
          <div id="gDelta" style="font-weight:700;">0円</div>
        </div>

        <div id="gList" style="margin-top:10px;"></div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="addGambleBtn">精算結果を追加</button>
          <button class="btn secondary" id="clearGambleBtn">クリア</button>
        </div>
      </section>
    </section>

    <!-- 結果 -->
    <section class="card">
      <h2>結果</h2>

      <div class="tableWrap">
        <table id="resultTable">
          <thead>
            <tr><th>名前</th><th class="right">使用額</th><th class="right">支払額</th><th class="right">勝敗</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:14px">
        <div style="font-size:14px;font-weight:600;">ギャンブル結果</div>
        <div class="tableWrap">
          <table id="gambleBalanceTable">
            <thead><tr><th>名前</th><th class="right">収支</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:12px;padding:10px 12px;border:1px solid #223;border-radius:12px;background:#0f1530">
          <div style="font-size:13px;opacity:.9;font-weight:700;margin-bottom:8px">総収支</div>
          <div id="econTotalLine" class="muted" style="margin:6px 0 10px 0;font-size:14px;font-weight:700;"></div>
          <div id="totalNetChips" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
      </div>
    </section>

    <!-- 支出一覧（カード） -->
    <section class="card">
      <details open id="txDetails">
        <summary style="cursor:pointer;font-weight:700;list-style:none;">
          支出一覧 <span class="muted small" style="font-weight:400;margin-left:8px;">クリックで開閉</span>
        </summary>

        <div class="sortbar">
          <select id="txSortSelect">
            <option value="createdDesc">新しい順</option>
            <option value="createdAsc">古い順</option>
            <option value="amountDesc">金額の大きい順</option>
            <option value="amountAsc">金額の小さい順</option>
          </select>
        </div>

        <div class="filtersGrid">
          <div>
            <label style="margin-top:0;">種類</label>
            <select id="txFilterType"><option value="">全て</option></select>
          </div>
          <div>
            <label style="margin-top:0;">支払者</label>
            <select id="txFilterPayer"><option value="">全て</option></select>
          </div>
          <div>
            <label style="margin-top:0;">恩恵者</label>
            <select id="txFilterBen"><option value="">全て</option></select>
          </div>
        </div>

        <div id="txCards" class="listCards"></div>
      </details>
    </section>

    
    <!-- ギャンブル集計一覧（カード） -->
    <section class="card">
      <details open id="gambleDetails">
        <summary style="cursor:pointer;font-weight:700;list-style:none;">
          ギャンブル集計一覧 <span class="muted small" style="font-weight:400;margin-left:8px;">クリックで開閉</span>
        </summary>

        <!-- ★追加：勝ち/負け 絞り込み（検索なし） -->
        <div class="filtersGrid" style="grid-template-columns:1fr 1fr; margin-top:10px;">
          <div>
            <label style="margin-top:0;">勝ちの人</label>
            <select id="gambleFilterWinMember">
              <option value="">全て</option>
            </select>
          </div>
          <div>
            <label style="margin-top:0;">負けの人</label>
            <select id="gambleFilterLoseMember">
              <option value="">全て</option>
            </select>
          </div>
        </div>

        <div id="gambleCards" class="listCards"></div>
      </details>
    </section>

  </main>
</div>

<!-- 恩恵者モーダル -->
<div id="benModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-size:16px; font-weight:600;">（恩恵者）個別金額を指定</div>
      <button class="btn secondary small" id="benModalCloseBtn" style="width:auto;min-height:40px">閉じる</button>
    </div>
    <div id="benModalList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;"></div>
    <div class="row" style="margin-top:12px;">
      <button class="btn secondary" id="benModalClearBtn">クリア</button>
      <button class="btn" id="benModalSaveBtn">反映</button>
    </div>
  </div>
</div>

<!-- 支払者モーダル -->
<div id="payModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-size:16px; font-weight:600;">（支払者）個別金額を指定</div>
      <button class="btn secondary small" id="payModalCloseBtn" style="width:auto;min-height:40px">閉じる</button>
    </div>
    <div id="payModalList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;"></div>
    <div class="row" style="margin-top:12px;">
      <button class="btn secondary" id="payModalClearBtn">クリア</button>
      <button class="btn" id="payModalSaveBtn">反映</button>
    </div>
  </div>
</div>

<!-- ギャンブル精算ポップアップ -->
<div id="settleModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-size:16px; font-weight:600;">ギャンブル精算結果</div>
    </div>
    <div id="settleList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>

    <div class="row" style="margin-top:12px;">
      <button class="btn secondary" id="settleCancelBtn">キャンセル</button>
      <button class="btn" id="settleSaveBtn">保存</button>
    </div>
  </div>
</div>

<!-- 支出内訳モーダル -->
<div id="txBreakdownModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-size:16px; font-weight:700;">内訳</div>
      <button class="btn secondary small" id="txBreakdownCloseBtn" style="width:auto;min-height:40px">閉じる</button>
    </div>

    <div id="txBreakdownHeader" class="muted" style="margin-top:10px;font-size:14px;"></div>

    <div class="kv">
      <div>
        <div style="font-weight:700;margin:8px 0 6px 0;">個別支払額</div>
        <table class="miniTable">
          <thead><tr><th>名前</th><th class="right">円</th></tr></thead>
          <tbody id="txPayBreakdownBody"></tbody>
        </table>
      </div>

      <div>
        <div style="font-weight:700;margin:8px 0 6px 0;">個別恩恵額</div>
        <table class="miniTable">
          <thead><tr><th>名前</th><th class="right">円</th></tr></thead>
          <tbody id="txBenBreakdownBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ★追加：メンバー詳細（円グラフ）モーダル -->
<div id="memberDetailModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div class="mdTitle" id="mdTitle">詳細</div>
      <button class="btn secondary small" id="mdCloseBtn" style="width:auto;min-height:40px">閉じる</button>
    </div>

    <div class="carousel" id="mdCarousel">
      <div class="slide">
        <h3>総支出（種類別）</h3>
        <div class="chartWrap"><canvas class="pie" id="pieExpType"></canvas></div>
        <div class="legend" id="lgExpType"></div>
      </div>

      <div class="slide">
        <h3>総収入（種類別）</h3>
        <div class="chartWrap"><canvas class="pie" id="pieIncType"></canvas></div>
        <div class="legend" id="lgIncType"></div>
      </div>

      <div class="slide">
        <h3>総支出（人別）</h3>
        <div class="chartWrap"><canvas class="pie" id="pieExpBen"></canvas></div>
        <div class="legend" id="lgExpBen"></div>
      </div>

      <div class="slide">
        <h3>総収入（人別）</h3>
        <div class="chartWrap"><canvas class="pie" id="pieIncPayer"></canvas></div>
        <div class="legend" id="lgIncPayer"></div>
      </div>
    </div>

    <div class="carCtrl">
      <button class="btn secondary navBtn" id="mdPrevBtn">←</button>
      <div class="dots" id="mdDots"></div>
      <button class="btn secondary navBtn" id="mdNextBtn">→</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, setDoc, updateDoc, deleteDoc, doc,
  onSnapshot, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDgHVdhx0RwTv6PkzBBNgY8Ouis7yRGwlY",
  authDomain: "trip-app-eb508.firebaseapp.com",
  projectId: "trip-app-eb508",
  storageBucket: "trip-app-eb508.firebasestorage.app",
  messagingSenderId: "38650349203",
  appId: "1:38650349203:web:1987ddb1536bca9bbe6f66",
  measurementId: "G-JBSHND42QP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ECON = "経済";
const TX_TYPES = ["交通費","宿代","食費","物代","交際費"];
const DEFAULT_TX_TYPE = "食費";
const LS_LAST_TRIP_KEY = "tripApp:lastTripId";

// ★追加：折りたたみ状態を保存
const LS_PANEL_KEY = "tripApp:panelOpen";

const byId=id=>document.getElementById(id);
const yen=n=>Math.round(n||0).toLocaleString();
const escapeHtml=s=>String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#039;"}[m]||({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])));
const uuid=()=>crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2));
function toInt(v){
  if(v==null) return 0;
  const n = String(v).replace(/[^\d-]/g,"");
  return Number.parseInt(n,10) || 0;
}
let _scrollY = 0;

function openModal(el){
  _scrollY = window.scrollY || 0;
  document.body.classList.add("modalOpen");
  document.body.style.position = "fixed";
  document.body.style.top = `-${_scrollY}px`;
  document.body.style.left = "0";
  document.body.style.right = "0";
  document.body.style.width = "100%";
  el.style.display="block";
}
function closeModal(el){
  el.style.display="none";
  document.body.classList.remove("modalOpen");
  document.body.style.position = "";
  document.body.style.top = "";
  document.body.style.left = "";
  document.body.style.right = "";
  document.body.style.width = "";
  window.scrollTo(0, _scrollY);
}


// DOM
const tripPanel = byId("tripPanel");
const tripPanelToggleBtn = byId("tripPanelToggleBtn");
const currentTripNameText = byId("currentTripNameText");

const newTripName=byId("newTripName");
const createTripBtn=byId("createTripBtn");
const tripSelect = byId("tripSelect");
const renameTripBtn = byId("renameTripBtn");
const memberName=byId("memberName");
const addMemberBtn=byId("addMemberBtn");
const membersDiv=byId("members");
const deleteTripBtn=byId("deleteTripBtn");

const tabExpenseBtn=byId("tabExpenseBtn");
const tabGambleBtn=byId("tabGambleBtn");
const tabExpense=byId("tabExpense");
const tabGamble=byId("tabGamble");

const txFormCard=byId("txFormCard");
const formTitle=byId("formTitle");
const txType=byId("txType");
const txDesc=byId("txDesc");
const txAmount=byId("txAmount");
const payersDiv=byId("payers");
const beneficiariesDiv=byId("beneficiaries");
const addTxBtn=byId("addTxBtn");
const clearFormBtn=byId("clearFormBtn");
const selectAllBenBtn=byId("selectAllBenBtn");
const editBenAmountsBtn=byId("editBenAmountsBtn");
const editPayerAmountsBtn=byId("editPayerAmountsBtn");

const benModal=byId("benModal");
const benModalList=byId("benModalList");
const benModalCloseBtn=byId("benModalCloseBtn");
const benModalSaveBtn=byId("benModalSaveBtn");
const benModalClearBtn=byId("benModalClearBtn");

const payModal=byId("payModal");
const payModalList=byId("payModalList");
const payModalCloseBtn=byId("payModalCloseBtn");
const payModalSaveBtn=byId("payModalSaveBtn");
const payModalClearBtn=byId("payModalClearBtn");

const resultBody=document.querySelector("#resultTable tbody");
const gambleBalanceBody=document.querySelector("#gambleBalanceTable tbody");
const totalNetChips=byId("totalNetChips");
const econTotalLine = byId("econTotalLine");

const txCards = byId("txCards");
const gambleCards = byId("gambleCards");
const gambleFilterWinMember = byId("gambleFilterWinMember");
const gambleFilterLoseMember = byId("gambleFilterLoseMember");

const gambleTitle=byId("gambleTitle");
const gDesc=byId("gDesc");
const gList=byId("gList");
const addGambleBtn=byId("addGambleBtn");
const clearGambleBtn=byId("clearGambleBtn");
const gDelta=byId("gDelta");

const settleModal = byId("settleModal");
const settleList  = byId("settleList");
const settleCancelBtn = byId("settleCancelBtn");
const settleSaveBtn   = byId("settleSaveBtn");

const txSortSelect = byId("txSortSelect");
const txFilterType = byId("txFilterType");
const txFilterPayer = byId("txFilterPayer");
const txFilterBen = byId("txFilterBen");

const txBreakdownModal = byId("txBreakdownModal");
const txBreakdownCloseBtn = byId("txBreakdownCloseBtn");
const txBreakdownHeader = byId("txBreakdownHeader");
const txPayBreakdownBody = byId("txPayBreakdownBody");
const txBenBreakdownBody = byId("txBenBreakdownBody");

txBreakdownCloseBtn?.addEventListener("click", ()=> closeModal(txBreakdownModal));
txBreakdownModal?.addEventListener("click", (e)=>{ if(e.target===txBreakdownModal) closeModal(txBreakdownModal); });

// ★追加：メンバー詳細モーダルDOM
const memberDetailModal = byId("memberDetailModal");
const mdTitle = byId("mdTitle");
const mdCloseBtn = byId("mdCloseBtn");
const mdCarousel = byId("mdCarousel");
const mdPrevBtn = byId("mdPrevBtn");
const mdNextBtn = byId("mdNextBtn");
const mdDots = byId("mdDots");

const pieExpType = byId("pieExpType");
const pieIncType = byId("pieIncType");
const pieExpBen  = byId("pieExpBen");
const pieIncPayer= byId("pieIncPayer");

const lgExpType = byId("lgExpType");
const lgIncType = byId("lgIncType");
const lgExpBen  = byId("lgExpBen");
const lgIncPayer= byId("lgIncPayer");

mdCloseBtn?.addEventListener("click", ()=> closeModal(memberDetailModal));
memberDetailModal?.addEventListener("click", (e)=>{ if(e.target===memberDetailModal) closeModal(memberDetailModal); });

// Firestore 状態
let tripsUnsub=null, currentTripUnsub=null;
let tripsIndex=[], currentTripId=null, currentTripData=null;
let editingTxId = null;

let editingGambleId = null;
let pendingGambleRecord = null;

let lastTripUnsub = null;
let remoteLastTripId = null;

let txSortKey = "createdDesc";
let txFilters = { type:"", payer:"", ben:"" };
let gambleFilters = { win:"", lose:"" };

// ===== ★追加：パネル折りたたみ初期化（デフォルト閉じる） =====
initPanel();
function initPanel(){
  const saved = localStorage.getItem(LS_PANEL_KEY);
  const open = (saved === "1") ? true : false; // デフォルトfalse
  setPanelOpen(open, false);

  tripPanelToggleBtn?.addEventListener("click", ()=>{
    const isOpen = tripPanel.classList.contains("open");
    setPanelOpen(!isOpen, true);
  });
}
function setPanelOpen(open, persist){
  tripPanel.classList.toggle("open", open);
  tripPanelToggleBtn.textContent = open ? "閉じる" : "開く";
  if(persist) localStorage.setItem(LS_PANEL_KEY, open ? "1" : "0");
}

// ===== 初期化 =====
init();
function init(){
  subscribeLastTripState();
  subscribeTrips();
  bindTabs();

  txSortSelect?.addEventListener("change", ()=>{
    txSortKey = txSortSelect.value || "createdDesc";
    renderTx();
  });

  txFilterType?.addEventListener("change", ()=>{
    txFilters.type = txFilterType.value || "";
    renderTx();
  });
  txFilterPayer?.addEventListener("change", ()=>{
    txFilters.payer = txFilterPayer.value || "";
    renderTx();
  });
  txFilterBen?.addEventListener("change", ()=>{
    txFilters.ben = txFilterBen.value || "";
    renderTx();
  });

  // ★追加：詳細モーダルのスライド操作
  initMemberDetailCarousel();

    // ★追加：ギャンブル集計一覧フィルタ
  gambleFilterWinMember?.addEventListener("change", ()=>{
    gambleFilters.win = gambleFilterWinMember.value || "";
    renderGambleListCards();
  });
  gambleFilterLoseMember?.addEventListener("change", ()=>{
    gambleFilters.lose = gambleFilterLoseMember.value || "";
    renderGambleListCards();
  });
}

function bindTabs(){
  tabExpenseBtn.addEventListener("click", ()=> setTab("expense"));
  tabGambleBtn.addEventListener("click", ()=> setTab("gamble"));
}
function setTab(kind){
  const isExpense = kind==="expense";
  tabExpenseBtn.classList.toggle("active", isExpense);
  tabGambleBtn.classList.toggle("active", !isExpense);
  tabExpense.classList.toggle("active", isExpense);
  tabGamble.classList.toggle("active", !isExpense);
}

// ===== 現在の旅行名表示（常に更新） =====
function updateCurrentTripNameUI(){
  const name = currentTripData?.name
    || tripsIndex.find(t=>t.id===currentTripId)?.name
    || (tripSelect?.selectedOptions?.[0]?.textContent ?? "")
    || "（未選択）";
  if(currentTripNameText) currentTripNameText.textContent = name || "（未選択）";
}

// ===== 最後に開いた旅行ID（Firestore）を購読 =====
function subscribeLastTripState(){
  if(lastTripUnsub) lastTripUnsub();
  const ref = doc(db, "appState", "lastTrip");
  lastTripUnsub = onSnapshot(ref, (d)=>{
    remoteLastTripId = d.exists() ? (d.data().tripId || null) : null;
    if(tripsIndex && tripsIndex.length) renderTripSelect();
  });
}

// ===== 旅行一覧購読 =====
tripSelect?.addEventListener("change", ()=>{ if(tripSelect.value) selectTrip(tripSelect.value); });

function subscribeTrips(){
  if(tripsUnsub) tripsUnsub();
  const q=query(collection(db,"trips"),orderBy("createdAt","asc"));
  tripsUnsub=onSnapshot(q,snap=>{
    tripsIndex=snap.docs.map(d=>({id:d.id,name:d.data().name||"(無題)"}));
    renderTripSelect();
  });
}

function renderTripSelect(){
  const prev = tripSelect.value;
  const lastLocal = localStorage.getItem(LS_LAST_TRIP_KEY);

  tripSelect.innerHTML="";
  tripsIndex.forEach(t=>{
    const opt=document.createElement("option");
    opt.value=t.id; opt.textContent=t.name||"(無題)";
    tripSelect.appendChild(opt);
  });

  const target =
      tripsIndex.find(t=>t.id===remoteLastTripId)?.id
   || tripsIndex.find(t=>t.id===lastLocal)?.id
   || tripsIndex.find(t=>t.id===currentTripId)?.id
   || tripsIndex.find(t=>t.id===prev)?.id
   || (tripsIndex[0]?.id || "");

  if(!target){
    clearMainViews();
    updateCurrentTripNameUI();
    return;
  }

  tripSelect.value = target;

  if(currentTripId !== target){
    selectTrip(target);
  }else{
    updateCurrentTripNameUI();
  }
}

async function selectTrip(id){
  currentTripId=id;
  localStorage.setItem(LS_LAST_TRIP_KEY, id);

  try{
    await setDoc(doc(db,"appState","lastTrip"), {
      tripId: id,
      updatedAt: serverTimestamp()
    }, { merge:true });
  }catch(e){ console.error(e); }

  clearForm();
  clearGambleForm(true);

  txFilters = { type:"", payer:"", ben:"" };
  if(txFilterType) txFilterType.value = "";
  if(txFilterPayer) txFilterPayer.value = "";
  if(txFilterBen) txFilterBen.value = "";

  subscribeCurrentTrip(id);
}

function subscribeCurrentTrip(id){
  if(currentTripUnsub) currentTripUnsub();
  const ref=doc(db,"trips",id);
  currentTripUnsub=onSnapshot(ref, async d=>{
    if(!d.exists()){ currentTripData=null; clearMainViews(); updateCurrentTripNameUI(); return; }
    currentTripData=d.data();

    if(!currentTripData.tx) currentTripData.tx = [];
    if(!currentTripData.gamble) currentTripData.gamble = [];
    if(!currentTripData.gambleBalance) currentTripData.gambleBalance = {};

    // ★旅行名を表示（閉じてても更新）
    updateCurrentTripNameUI();

    const members = currentTripData.members || [];
    const correctBal = recomputeGambleBalance(currentTripData.gamble || [], members);
    const needFix = !shallowEqualNumberMap(correctBal, currentTripData.gambleBalance || {}, members);
    if(needFix){
      try{
        await updateDoc(doc(db,"trips",currentTripId),{ gambleBalance: correctBal });
      }catch(e){ console.error(e); }
      currentTripData.gambleBalance = correctBal;
    }

    renderMembers();
    renderPayerAndBen();
    updateTxFilterOptions();

    renderTx();
    renderResults();
    renderGambleForm();
    renderGambleBalance();
    renderTotalNet();
    updateGambleWinLoseFilterOptions();
    renderGambleListCards();
  });
}

function clearMainViews(){
  membersDiv.innerHTML=""; payersDiv.innerHTML=""; beneficiariesDiv.innerHTML="";
  if(txCards) txCards.innerHTML="";
  if(gambleCards) gambleCards.innerHTML="";
  resultBody.innerHTML="";
  gambleBalanceBody.innerHTML="";
  if(totalNetChips) totalNetChips.innerHTML="";
  if(econTotalLine) econTotalLine.textContent = "";
  gList.innerHTML="";
}

function renderMembers(){
  membersDiv.innerHTML="";
  (currentTripData.members||[]).forEach(m=>{
    const span=document.createElement("span");
    span.className="chip"; span.textContent=m+" ";
    const x=document.createElement("button");
    x.textContent="×"; x.className="btn small"; x.style.width="auto"; x.style.minHeight="32px"; x.style.padding="6px 10px";
    x.onclick=()=> removeMember(m);
    span.appendChild(x);
    membersDiv.appendChild(span);
  });
}

function renderPayerAndBen(){
  const state={payers:[], bens:[]};
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked) state.payers.push({name:cb.value, amount:cb.dataset.amount});
  });
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked) state.bens.push({name:cb.value, amount:cb.dataset.amount});
  });

  payersDiv.innerHTML="";
  (currentTripData.members||[]).forEach(name=>{
    const label=document.createElement("label"); label.className="chip";
    const cb=document.createElement("input");
    cb.type="checkbox"; cb.value=name; cb.checked=false; cb.dataset.amount="";
    cb.addEventListener("change", ()=>{ if(!cb.checked) cb.dataset.amount=""; });
    label.appendChild(cb); label.append(" "+name);
    payersDiv.appendChild(label);
  });

  beneficiariesDiv.innerHTML="";
  const benList=[...(currentTripData.members||[]), ECON];
  benList.forEach(name=>{
    const label=document.createElement("label"); label.className="chip";
    const cb=document.createElement("input");
    cb.type="checkbox"; cb.value=name; cb.checked=false; cb.dataset.amount="";
    cb.addEventListener("change", ()=>{ if(!cb.checked) cb.dataset.amount=""; });
    label.appendChild(cb); label.append(" "+name);
    beneficiariesDiv.appendChild(label);
  });

  const isInit = (state.payers.length===0 && state.bens.length===0 && !editingTxId);
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(isInit){ cb.checked=false; cb.dataset.amount=""; return; }
    const hit=state.payers.find(x=>x.name===cb.value);
    cb.checked=!!hit;
    cb.dataset.amount = hit?.amount ? String(toInt(hit.amount)) : "";
  });
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(isInit){ cb.checked=false; cb.dataset.amount=""; return; }
    const hit=state.bens.find(x=>x.name===cb.value);
    cb.checked=!!hit;
    cb.dataset.amount = hit?.amount ? String(toInt(hit.amount)) : "";
  });
}

function rebuildSelectOptions(sel, options, keepValue){
  if(!sel) return;
  const cur = keepValue ?? sel.value ?? "";
  sel.innerHTML = "";
  const optAll=document.createElement("option");
  optAll.value=""; optAll.textContent="全て";
  sel.appendChild(optAll);

  options.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    sel.appendChild(o);
  });

  const exists = Array.from(sel.options).some(o=>o.value===cur);
  sel.value = exists ? cur : "";
}

function updateGambleWinLoseFilterOptions(){
  if(!gambleFilterWinMember || !gambleFilterLoseMember) return;
  if(!currentTripData) return;

  const members = currentTripData.members || [];
  const gamble  = currentTripData.gamble  || [];

  const winSet = new Set();
  const loseSet = new Set();

  gamble.forEach(g=>{
    members.forEach(m=>{
      const v = Number(g?.entries?.[m] || 0);
      if(v > 0) winSet.add(m);
      if(v < 0) loseSet.add(m);
    });
  });

  const prevWin = gambleFilters.win || "";
  const prevLose = gambleFilters.lose || "";

  // 勝ち
  gambleFilterWinMember.innerHTML = `<option value="">全て</option>`;
  Array.from(winSet).sort().forEach(m=>{
    const o=document.createElement("option");
    o.value=m; o.textContent=m;
    gambleFilterWinMember.appendChild(o);
  });

  // 負け
  gambleFilterLoseMember.innerHTML = `<option value="">全て</option>`;
  Array.from(loseSet).sort().forEach(m=>{
    const o=document.createElement("option");
    o.value=m; o.textContent=m;
    gambleFilterLoseMember.appendChild(o);
  });

  // 以前の選択がまだ有効なら保持、無効なら全てに戻す
  gambleFilterWinMember.value = Array.from(gambleFilterWinMember.options).some(o=>o.value===prevWin) ? prevWin : "";
  gambleFilterLoseMember.value = Array.from(gambleFilterLoseMember.options).some(o=>o.value===prevLose) ? prevLose : "";

  gambleFilters.win  = gambleFilterWinMember.value || "";
  gambleFilters.lose = gambleFilterLoseMember.value || "";
}

function updateTxFilterOptions(){
  const members = currentTripData?.members || [];
  const tx = currentTripData?.tx || [];

  const typeSet = new Set(TX_TYPES);
  tx.forEach(t=>{ if(t?.type) typeSet.add(String(t.type)); });
  const types = Array.from(typeSet).filter(Boolean);

  const payers = [...members];
  const bens = [...members, ECON];

  rebuildSelectOptions(txFilterType, types, txFilters.type);
  rebuildSelectOptions(txFilterPayer, payers, txFilters.payer);
  rebuildSelectOptions(txFilterBen, bens, txFilters.ben);

  txFilters.type = txFilterType?.value || "";
  txFilters.payer = txFilterPayer?.value || "";
  txFilters.ben = txFilterBen?.value || "";
}

function applyTxFilters(list){
  const members=currentTripData?.members||[];
  const fType = txFilters.type || "";
  const fPayer = txFilters.payer || "";
  const fBen = txFilters.ben || "";

  return list.filter(t=>{
    if(fType && String(t.type||"") !== fType) return false;
    if(fPayer){
      const payers = (t.payers && t.payers.length) ? t.payers : (t.payer ? [t.payer] : []);
      const p2 = payers.filter(p=>members.includes(p));
      if(!p2.includes(fPayer)) return false;
    }
    if(fBen){
      const ben = (t.ben || []);
      if(!ben.includes(fBen)) return false;
    }
    return true;
  });
}

function sortTxList(list, key){
  const withIdx = list.map((t,idx)=>({t, idx}));
  const num = (v)=> Number(v||0);
  const cmpNum = (a,b)=> (a<b?-1:a>b?1:0);

  const cmp = (a,b)=>{
    const A=a.t, B=b.t;
    switch(key){
      case "createdAsc":  return a.idx - b.idx;
      case "createdDesc": return b.idx - a.idx;
      case "amountAsc":   return cmpNum(num(A.amount), num(B.amount)) || (a.idx-b.idx);
      case "amountDesc":  return cmpNum(num(B.amount), num(A.amount)) || (a.idx-b.idx);
      default: return b.idx - a.idx;
    }
  };

  return withIdx.sort(cmp).map(x=>x.t);
}

function computeTxBreakdown(t){
  const members = currentTripData?.members || [];
  const amount = Number(t.amount)||0;

  const payers = (t.payers && t.payers.length) ? t.payers.filter(p=>members.includes(p))
                : (t.payer ? [t.payer].filter(p=>members.includes(p)) : []);
  const payerAmounts = t.payerAmounts || {};

  const benList = (t.ben || []).filter(b => members.includes(b) || b === ECON);
  const benAmounts = t.benAmounts || {};

  const payerOut = {};
  let sumFixedPay = 0;
  const fixedPaySet = new Set();
  payers.forEach(p=>{
    const v = Number(payerAmounts?.[p]||0);
    if(v>0){
      payerOut[p]=Math.round(v);
      sumFixedPay += v;
      fixedPaySet.add(p);
    }
  });
  const remainPay = amount - sumFixedPay;
  const flexPayers = payers.filter(p=>!fixedPaySet.has(p));
  const sharePay = flexPayers.length ? (remainPay / flexPayers.length) : 0;
  flexPayers.forEach(p=>{ payerOut[p]=Math.round(sharePay); });

  const benOut = {};
  let sumFixedBen = 0;
  const fixedBenSet = new Set();
  benList.forEach(b=>{
    const v = Number(benAmounts?.[b]||0);
    if(v>0){
      benOut[b]=Math.round(v);
      sumFixedBen += v;
      fixedBenSet.add(b);
    }
  });
  const remainBen = amount - sumFixedBen;
  const flexBen = benList.filter(b=>!fixedBenSet.has(b));
  const shareBen = flexBen.length ? (remainBen / flexBen.length) : 0;
  flexBen.forEach(b=>{ benOut[b]=Math.round(shareBen); });

  return { payerOut, benOut, payers, benList, amount };
}

function openTxBreakdownModal(txId){
  const t = (currentTripData?.tx || []).find(x=>x.id===txId);
  if(!t) return;

  const { payerOut, benOut, payers, benList, amount } = computeTxBreakdown(t);
  const type = t.type || "（未設定）";
  const desc = t.desc || "（説明なし）";

  txBreakdownHeader.innerHTML =
    `<div><b>${escapeHtml(type)}</b> / ${escapeHtml(desc)}</div>
     <div style="margin-top:6px;">金額：<b style="font-size:16px;">${yen(amount)}円</b></div>`;

  txPayBreakdownBody.innerHTML="";
  payers.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(p)}</td><td class="right">${yen(payerOut[p]||0)}</td>`;
    txPayBreakdownBody.appendChild(tr);
  });

  txBenBreakdownBody.innerHTML="";
  benList.forEach(b=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(b)}</td><td class="right">${yen(benOut[b]||0)}</td>`;
    txBenBreakdownBody.appendChild(tr);
  });

  openModal(txBreakdownModal);
}

function renderTx(){
  const txRaw = [...(currentTripData.tx||[])];
  const filtered = applyTxFilters(txRaw);
  const tx = sortTxList(filtered, txSortKey);

  txCards.innerHTML="";

  tx.forEach(t=>{
    const type = t.type || "（未設定）";
    const desc = t.desc || "";
    const amount = Number(t.amount)||0;

    const payers = (t.payers && t.payers.length) ? t.payers : (t.payer ? [t.payer] : []);
    const ben = (t.ben||[]);

    const card=document.createElement("div");
    card.className="itemCard";
    card.innerHTML = `
      <div class="itemTop">
        <div class="itemTitle">
          <span class="pill">${escapeHtml(type)}</span>
          ${
            desc
              ? `<span class="wrapText descTap" data-txdetail="${escapeHtml(t.id)}">${escapeHtml(desc)}</span>`
              : `<span class="muted descTap" data-txdetail="${escapeHtml(t.id)}">（説明なし）</span>`
          }
        </div>
        <div class="itemAmount">${yen(amount)}円</div>
      </div>

      <div class="itemMeta">
        <div class="k">支払者</div>
        <div class="wrapText">${escapeHtml(payers.join("、"))}</div>

        <div class="k">恩恵者</div>
        <div class="wrapText">${escapeHtml(ben.join("、"))}</div>
      </div>

      <div class="itemActions">
        <button class="btn actionBtn secondary" data-edit="${escapeHtml(t.id)}">編集</button>
        <button class="btn actionBtn danger" data-del="${escapeHtml(t.id)}">削除</button>
      </div>
    `;
    txCards.appendChild(card);
  });

  txCards.onclick=(e)=>{
    const detail = e.target.closest("[data-txdetail]");
    if(detail){ openTxBreakdownModal(detail.dataset.txdetail); return; }

    const delBtn=e.target.closest("button[data-del]");
    if(delBtn) deleteTx(delBtn.dataset.del);

    const editBtn=e.target.closest("button[data-edit]");
    if(editBtn) startEditTx(editBtn.dataset.edit);
  };
}

function computeExpenseStats(){
  const members=currentTripData.members||[];
  const tx=currentTripData.tx||[];

  const fair=Object.fromEntries(members.map(m=>[m,0]));
  const paid=Object.fromEntries(members.map(m=>[m,0]));
  let econTotal = 0;

  for(const t of tx){
    const amount=Number(t.amount)||0;

    const payers = (t.payers && t.payers.length) ? t.payers.filter(p=>members.includes(p))
                  : (t.payer ? [t.payer] : []);
    if(payers.length===0) continue;

    const payerAmounts=t.payerAmounts||{};
    let sumFixedPay=0;
    const fixedPayers=[];
    for(const p of payers){
      const v=payerAmounts?.[p];
      if(v){
        paid[p]=(paid[p]||0)+Number(v);
        sumFixedPay+=Number(v);
        fixedPayers.push(p);
      }
    }
    const remainPay=amount-sumFixedPay;
    const othersPay=payers.filter(p=>!fixedPayers.includes(p));
    const sharePay=othersPay.length ? remainPay/othersPay.length : 0;
    for(const p of othersPay) paid[p]=(paid[p]||0)+sharePay;

    const benList = (t.ben || []).filter(b => members.includes(b) || b === ECON);
    if(benList.length === 0) continue;

    const benAmounts = t.benAmounts || {};
    let sumFixedBen = 0;
    benList.forEach(b=>{
      const v = Number(benAmounts?.[b] || 0);
      if(v > 0) sumFixedBen += v;
    });

    const remainBen = amount - sumFixedBen;
    const flex = benList.filter(b => !(Number(benAmounts?.[b] || 0) > 0));
    const shareBen = flex.length ? (remainBen / flex.length) : 0;

    benList.forEach(b=>{
      const fixed = Number(benAmounts?.[b] || 0);
      const alloc = (fixed > 0) ? fixed : shareBen;

      if(members.includes(b)){
        fair[b] = (fair[b]||0) + alloc;
      }else if(b === ECON){
        econTotal += alloc;
      }
    });
  }

  const expenseNet = Object.fromEntries(members.map(m=>{
    const f=Math.round(fair[m]||0);
    const p=Math.round(paid[m]||0);
    return [m, Math.round(f - p)];
  }));

  return { members, fair, paid, econTotal, expenseNet };
}

function renderResults(){
  const { members, fair, paid, expenseNet } = computeExpenseStats();

  resultBody.innerHTML="";
  members.forEach(m=>{
    const f=Math.round(fair[m]||0);
    const p=Math.round(paid[m]||0);
    const net = Math.round(expenseNet[m]||0);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${escapeHtml(m)}</td>
      <td class="right">${yen(f)}</td>
      <td class="right">${yen(p)}</td>
      <td class="right"><span class="pill ${net>=0?"plus":"minus"}">${net>=0?"+":""}${yen(net)}</span></td>`;
    resultBody.appendChild(tr);
  });
}

function renderTotalNet(){
  if(!totalNetChips) return;
  const { members, expenseNet, econTotal } = computeExpenseStats();
  const gb = currentTripData.gambleBalance || {};

  if(econTotalLine){
    econTotalLine.innerHTML = `経済を回した金額：<span style="font-size:16px;font-weight:900;">${yen(Math.round(econTotal))}円</span>`;
  }

  totalNetChips.innerHTML="";
  members.forEach(m=>{
    const g = Math.round(Number(gb[m]||0));
    const e = Math.round(Number(expenseNet[m]||0));
    const t = Math.round(e + g);

    const div=document.createElement("div");
    div.dataset.member = m;               // ★追加：クリック対象
    div.style.cursor = "pointer";         // ★追加：押せる感
    div.style.display="flex";
    div.style.alignItems="center";
    div.style.justifyContent="space-between";
    div.style.gap="10px";
    div.style.padding="12px 12px";
    div.style.border="1px solid #223";
    div.style.borderRadius="999px";
    div.style.background="#121833";
    div.style.fontWeight="800";
    div.innerHTML = `
      <span>${escapeHtml(m)}</span>
      <span class="pill ${t>=0?"plus":"minus"}" style="font-size:14px;padding:5px 12px;">
        ${t>=0?"+":""}${yen(t)}
      </span>
    `;
    totalNetChips.appendChild(div);
  });

  // ★追加：クリックで詳細モーダル
  totalNetChips.onclick = (e)=>{
    const row = e.target.closest("[data-member]");
    if(!row) return;
    const name = row.dataset.member;
    if(!name) return;
    openMemberDetail(name);
  };
}

// ===== ギャンブルUI =====
function renderGambleForm(){
  const members=currentTripData?.members||[];
  if(!gList) return;

  gList.innerHTML="";

  const head=document.createElement("div");
  head.className="gRow";
  head.style.fontWeight="600";
  head.style.opacity=".9";
  head.innerHTML=`<div>名前</div><div>勝敗</div><div>金額</div>`;
  gList.appendChild(head);

  members.forEach(name=>{
    const row=document.createElement("div");
    row.className="gRow";

    const nameDiv=document.createElement("div");
    nameDiv.textContent=name;

    const signBtn=document.createElement("button");
    signBtn.type="button";
    signBtn.className="signBtn plus";
    signBtn.textContent="＋";
    signBtn.dataset.sign="+";
    signBtn.addEventListener("click", ()=>{
      const s=signBtn.dataset.sign==="+" ? "-" : "+";
      signBtn.dataset.sign=s;
      signBtn.classList.toggle("plus", s==="+");
      signBtn.classList.toggle("minus", s==="-");
      signBtn.textContent = (s==="+") ? "＋" : "−";
      updateGambleDelta();
    });

    const amount=document.createElement("input");
    amount.type="text";
    amount.inputMode="decimal";
    amount.placeholder="例：1000";
    amount.dataset.name=name;
    amount.addEventListener("input", updateGambleDelta);

    row.appendChild(nameDiv);
    row.appendChild(signBtn);
    row.appendChild(amount);
    gList.appendChild(row);
  });

  updateGambleDelta();
}

function setGambleEditMode(on){
  if(on){
    gambleTitle.textContent = "ギャンブル精算（編集）";
    addGambleBtn.textContent = "精算結果を更新";
    clearGambleBtn.textContent = "キャンセル";
  }else{
    gambleTitle.textContent = "ギャンブル精算";
    addGambleBtn.textContent = "精算結果を追加";
    clearGambleBtn.textContent = "クリア";
  }
}

function clearGambleForm(resetMode=false){
  gDesc.value="";
  if(gList) {
    gList.querySelectorAll('input[data-name]').forEach(inp=> inp.value="");
    gList.querySelectorAll('button.signBtn').forEach(btn=>{
      btn.dataset.sign="+";
      btn.classList.add("plus"); btn.classList.remove("minus");
      btn.textContent="＋";
    });
  }
  updateGambleDelta();

  if(resetMode){
    editingGambleId = null;
    setGambleEditMode(false);
  }
}
clearGambleBtn?.addEventListener("click", ()=>{
  if(editingGambleId){
    editingGambleId=null;
    setGambleEditMode(false);
  }
  clearGambleForm(false);
});

function readGambleEntries(){
  const members = currentTripData?.members || [];
  const entries = {};
  let sum = 0;

  const rows = [...gList.querySelectorAll(".gRow")].slice(1);
  rows.forEach(r=>{
    const inp = r.querySelector('input[data-name]');
    const btn = r.querySelector('button.signBtn');
    if(!inp || !btn) return;

    const name = inp.dataset.name;
    const abs = toInt(inp.value);
    const sign = btn.dataset.sign || "+";
    const val = (sign === "-" ? -abs : abs);

    entries[name] = val;
    sum += val;
  });

  const cleaned = {};
  members.forEach(m => cleaned[m] = Number(entries[m] || 0));
  return { entries: cleaned, sum };
}

function applyEntriesToForm(entries){
  const rows = [...gList.querySelectorAll(".gRow")].slice(1);
  rows.forEach(r=>{
    const inp = r.querySelector('input[data-name]');
    const btn = r.querySelector('button.signBtn');
    if(!inp || !btn) return;
    const name = inp.dataset.name;
    const v = Number(entries?.[name] || 0);
    const sign = v < 0 ? "-" : "+";
    const abs = Math.abs(Math.round(v));

    btn.dataset.sign = sign;
    btn.classList.toggle("plus", sign==="+");
    btn.classList.toggle("minus", sign==="-");
    btn.textContent = (sign==="+") ? "＋" : "−";
    inp.value = abs ? String(abs) : "";
  });
  updateGambleDelta();
}

function updateGambleDelta(){
  if(!gDelta || !currentTripData) return;
  const { sum } = readGambleEntries();
  const v = sum;
  const pillClass = (v===0) ? "plus" : (v>0 ? "plus" : "minus");
  gDelta.innerHTML = `<span class="pill ${pillClass}">${v>=0?"+":""}${yen(v)}円</span>`;
}

addGambleBtn?.addEventListener("click", ()=>{
  if(!currentTripData || !currentTripId) return;

  const members=currentTripData.members||[];
  const desc=(gDesc.value||"").trim() || "（無題）";

  const { entries, sum } = readGambleEntries();

  if(Object.values(entries).every(v=>v===0)){
    alert("1人以上、金額を入力してください");
    return;
  }
  if(sum!==0){
    alert(`合計が0円ではありません（現在：${yen(sum)}円）。勝ちと負けの合計が0になるように入力してください。`);
    return;
  }

  const transfers = computeTransfers(entries, members);

  settleList.innerHTML="";
  if(transfers.length===0){
    const div=document.createElement("div");
    div.className="muted";
    div.textContent="支払いは発生しません。";
    settleList.appendChild(div);
  } else {
    transfers.forEach(t=>{
      const div=document.createElement("div");
      div.innerHTML = `<span class="pill minus">${escapeHtml(t.from)}</span> → <span class="pill plus">${escapeHtml(t.to)}</span>　<span style="font-weight:600">${yen(t.amount)}円</span>`;
      settleList.appendChild(div);
    });
  }

  pendingGambleRecord = {
    id: editingGambleId || uuid(),
    desc,
    entries,
    transfers
  };

  openModal(settleModal);
});

settleCancelBtn?.addEventListener("click", ()=>{
  pendingGambleRecord = null;
  closeModal(settleModal);
});
settleModal?.addEventListener("click", (e)=>{
  if(e.target === settleModal){
    pendingGambleRecord = null;
    closeModal(settleModal);
  }
});

settleSaveBtn?.addEventListener("click", async ()=>{
  if(!pendingGambleRecord || !currentTripData || !currentTripId) return;

  const members = currentTripData.members || [];
  const gambleList = [...(currentTripData.gamble || [])];

  const idx = gambleList.findIndex(g => g.id === pendingGambleRecord.id);
  if(idx !== -1) gambleList[idx] = pendingGambleRecord;
  else gambleList.push(pendingGambleRecord);

  const newBal = recomputeGambleBalance(gambleList, members);

  try{
    await updateDoc(doc(db,"trips",currentTripId),{
      gamble: gambleList,
      gambleBalance: newBal
    });

    pendingGambleRecord=null;
    closeModal(settleModal);

    editingGambleId = null;
    setGambleEditMode(false);

    clearGambleForm(false);
    setTab("expense");
  }catch(e){
    console.error(e);
    alert("保存に失敗しました");
  }
});

function computeTransfers(entries, members){
  const creditors=[];
  const debtors=[];
  members.forEach(m=>{
    const v=Number(entries[m]||0);
    if(v>0) creditors.push({name:m, amt:v});
    else if(v<0) debtors.push({name:m, amt:-v});
  });

  const transfers=[];
  let i=0,j=0;
  while(i<debtors.length && j<creditors.length){
    const d=debtors[i];
    const c=creditors[j];
    const x=Math.min(d.amt, c.amt);
    if(x>0){
      transfers.push({from:d.name, to:c.name, amount: Math.round(x)});
      d.amt-=x;
      c.amt-=x;
    }
    if(d.amt<=0.000001) i++;
    if(c.amt<=0.000001) j++;
  }
  return transfers;
}

function renderGambleBalance(){
  const members = currentTripData.members || [];
  const bal = currentTripData.gambleBalance || {};

  gambleBalanceBody.innerHTML="";
  members.forEach(m=>{
    const v = Math.round(Number(bal[m]||0));
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(m)}</td>
      <td class="right"><span class="pill ${v>=0?"plus":"minus"}">${v>=0?"+":""}${yen(v)}</span></td>
    `;
    gambleBalanceBody.appendChild(tr);
  });
}

function renderGambleListCards(){
  if(!currentTripData) return;

  const win = gambleFilters.win || "";
  const lose = gambleFilters.lose || "";

  // 逆順表示（新しいのが上）
  let list = [...(currentTripData.gamble||[])].reverse();

  // ★勝ち/負け 絞り込み
  list = list.filter(g=>{
    if(win){
      const v = Number(g?.entries?.[win] || 0);
      if(v <= 0) return false;
    }
    if(lose){
      const v = Number(g?.entries?.[lose] || 0);
      if(v >= 0) return false;
    }
    return true;
  });

  gambleCards.innerHTML="";

  list.forEach(g=>{
    const payments = (g.transfers||[]).map(t=>`${t.from} → ${t.to} ${yen(t.amount)}円`);
    const payText = payments.length ? payments.join("／") : "支払いなし";

    const card=document.createElement("div");
    card.className="itemCard";
    card.innerHTML = `
      <div class="itemTop">
        <div class="itemTitle">
          <span class="wrapText">${escapeHtml(g.desc||"（無題）")}</span>
        </div>
      </div>

      <div class="itemMeta" style="grid-template-columns: 1fr;">
        <div class="wrapText">${escapeHtml(payText)}</div>
      </div>

      <div class="itemActions">
        <button class="btn actionBtn secondary" data-gedit="${escapeHtml(g.id)}">編集</button>
        <button class="btn actionBtn danger" data-gdel="${escapeHtml(g.id)}">削除</button>
      </div>
    `;
    gambleCards.appendChild(card);
  });

  gambleCards.onclick=(e)=>{
    const delBtn = e.target.closest("button[data-gdel]");
    if(delBtn) deleteGamble(delBtn.dataset.gdel);

    const editBtn = e.target.closest("button[data-gedit]");
    if(editBtn) startEditGamble(editBtn.dataset.gedit);
  };
}

function startEditGamble(id){
  const g = (currentTripData.gamble||[]).find(x=>x.id===id);
  if(!g) return;

  editingGambleId = id;
  setGambleEditMode(true);

  gDesc.value = g.desc || "";
  setTab("gamble");
  applyEntriesToForm(g.entries || {});
  byId("gambleCard").scrollIntoView({ behavior:"smooth" });
}

async function deleteGamble(id){
  if(!currentTripData || !currentTripId) return;
  if(!confirm("このギャンブル精算を削除しますか？")) return;

  const members = currentTripData.members || [];
  const gambleList = (currentTripData.gamble||[]).filter(g=>g.id!==id);
  const newBal = recomputeGambleBalance(gambleList, members);

  if(editingGambleId === id){
    editingGambleId = null;
    setGambleEditMode(false);
    clearGambleForm(false);
  }

  await updateDoc(doc(db,"trips",currentTripId),{
    gamble: gambleList,
    gambleBalance: newBal
  });
}

function recomputeGambleBalance(gambleList, members){
  const bal = Object.fromEntries((members||[]).map(m=>[m,0]));
  (gambleList||[]).forEach(g=>{
    const entries = g.entries || {};
    (members||[]).forEach(m=>{
      bal[m] = Number(bal[m]||0) + Number(entries[m]||0);
    });
  });
  return bal;
}
function shallowEqualNumberMap(a,b,members){
  const ms = members || [];
  for(const m of ms){
    const av = Number(a?.[m]||0);
    const bv = Number(b?.[m]||0);
    if(av !== bv) return false;
  }
  return true;
}

// ===== 支出操作 =====
createTripBtn.addEventListener("click", async ()=>{
  const name=(newTripName.value||"").trim()||"新しい旅行";
  const ref = await addDoc(collection(db,"trips"),{
    name,
    members:[],
    tx:[],
    gamble:[],
    gambleBalance:{},
    createdAt:serverTimestamp()
  });
  await selectTrip(ref.id);
  newTripName.value="";
});

renameTripBtn.addEventListener("click", async ()=>{
  if(!currentTripId || !currentTripData) return;
  const curName = currentTripData.name || "";
  const newName = prompt("新しい旅行名を入力してください", curName);
  if(newName && newName !== curName) {
    await updateDoc(doc(db, "trips", currentTripId), { name: newName });
  }
});

addMemberBtn.addEventListener("click", async ()=>{
  if(!currentTripData || !currentTripId) return;
  const m=(memberName.value||"").trim();
  if(!m) return;

  const members=[...(currentTripData.members||[])];
  if(members.includes(m)) { memberName.value=""; return; }
  members.push(m);

  const tx = (currentTripData.tx||[]).map(t=>({
    ...t,
    ben: (t.ben||[]).filter(b=>members.includes(b) || b===ECON),
    payers: (t.payers|| (t.payer?[t.payer]:[])).filter(p=>members.includes(p)),
    payerAmounts: cleanMapByMembers(t.payerAmounts||{}, members),
    benAmounts: cleanMapByMembers(t.benAmounts||{}, [...members, ECON])
  }));

  const gamble = (currentTripData.gamble||[]).map(g=>{
    const entries = cleanMapByMembers(g.entries||{}, members);
    members.forEach(x=>{ if(entries[x]==null) entries[x]=0; });
    const transfers = (g.transfers||[]).filter(t=>members.includes(t.from) && members.includes(t.to));
    return { ...g, entries, transfers };
  });

  const gambleBalance = recomputeGambleBalance(gamble, members);

  await setDoc(doc(db,"trips",currentTripId),{ ...currentTripData, members, tx, gamble, gambleBalance });
  memberName.value="";

  updateTxFilterOptions();
  renderTx();
});

deleteTripBtn.addEventListener("click", async ()=>{
  if(!currentTripId) return;
  if(!confirm("本当にこの旅行を削除しますか？")) return;
  await deleteDoc(doc(db,"trips",currentTripId));
  currentTripId=null; currentTripData=null;
  clearMainViews();
  updateCurrentTripNameUI();
});

addTxBtn.addEventListener("click", async ()=>{
  if(!currentTripData || !currentTripId) return;

  const type = (txType?.value || DEFAULT_TX_TYPE);
  const desc=(txDesc.value||"").trim();
  const amount = toInt(txAmount.value);

  const payers = [];
  const payerAmounts = {};
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked){
      payers.push(cb.value);
      if(cb.dataset.amount) payerAmounts[cb.value] = toInt(cb.dataset.amount);
    }
  });

  const ben = [];
  const benAmounts = {};
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked){
      ben.push(cb.value);
      if(cb.dataset.amount) benAmounts[cb.value] = toInt(cb.dataset.amount);
    }
  });

  if(!amount){ alert("金額は1円以上で入力してください"); return; }
  if(payers.length===0){ alert("支払者を1人以上選んでください"); return; }
  if(ben.length===0){ alert("恩恵者を1人以上選んでください"); return; }

  const sumP = Object.values(payerAmounts).reduce((a,b)=>a+(Number(b)||0),0);
  if(sumP > amount){ alert("個別金額の合計が、支出金額を超えています。"); return; }
  const sumB = Object.values(benAmounts).reduce((a,b)=>a+(Number(b)||0),0);
  if(sumB > amount){ alert("個別金額の合計が、支出金額を超えています。"); return; }

  let newTxList = [...(currentTripData.tx||[])];

  const txObj = {
    id: editingTxId || uuid(),
    type,
    desc,
    amount,
    payers,
    payer:payers[0],
    payerAmounts,
    ben,
    benAmounts
  };

  if(editingTxId) {
    const idx = newTxList.findIndex(t => t.id === editingTxId);
    if(idx !== -1) newTxList[idx] = txObj;
    else newTxList.push(txObj);
  } else {
    newTxList.push(txObj);
  }

  const isEdit = !!editingTxId;
  if(!confirm(isEdit ? "この内容で更新しますか？" : "この内容で追加しますか？")) return;

  try {
    await updateDoc(doc(db,"trips",currentTripId),{ tx: newTxList });
    clearForm();

    updateTxFilterOptions();
    renderTx();
  } catch (e) {
    console.error(e);
    alert("保存に失敗しました");
  }
});

clearFormBtn.addEventListener("click", ()=>{ clearForm(); });

async function deleteTx(id){
  if(!currentTripData || !currentTripId) return;
  if(!confirm("この支出を削除しますか？")) return;
  const tx=(currentTripData.tx||[]).filter(t=>t.id!==id);
  if(editingTxId === id) clearForm();
  await updateDoc(doc(db,"trips",currentTripId),{ tx });

  updateTxFilterOptions();
  renderTx();
}

function startEditTx(id) {
  const t = (currentTripData.tx||[]).find(x => x.id === id);
  if(!t) return;

  editingTxId = id;
  txFormCard.classList.add("editing-mode");
  formTitle.textContent = "支出を編集";
  addTxBtn.textContent = "支出を更新";
  clearFormBtn.textContent = "キャンセル";

  const curType = (t.type && TX_TYPES.includes(t.type)) ? t.type : DEFAULT_TX_TYPE;
  if(txType) txType.value = curType;

  txDesc.value = t.desc || "";
  txAmount.value = t.amount;

  const payers = t.payers || (t.payer ? [t.payer] : []);
  const payerAmounts = t.payerAmounts || {};
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    const on = payers.includes(cb.value);
    cb.checked = on;
    cb.dataset.amount = (on && payerAmounts[cb.value]) ? String(toInt(payerAmounts[cb.value])) : "";
  });

  const bens = t.ben || [];
  const benAmounts = t.benAmounts || {};
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    const on = bens.includes(cb.value);
    cb.checked = on;
    cb.dataset.amount = (on && benAmounts[cb.value]) ? String(toInt(benAmounts[cb.value])) : "";
  });

  setTab("expense");
  txFormCard.scrollIntoView({ behavior: "smooth" });
}

async function removeMember(name){
  if(!confirm(`${name} をメンバーから削除しますか？`)) return;

  const members=(currentTripData.members||[]).filter(m=>m!==name);

  const tx=(currentTripData.tx||[]).map(t=>{
    const payers = (t.payers || (t.payer?[t.payer]:[])).filter(p=>p!==name);
    const ben = (t.ben||[]).filter(b=>b!==name);
    const payerAmounts = {...(t.payerAmounts||{})}; delete payerAmounts[name];
    const benAmounts = {...(t.benAmounts||{})}; delete benAmounts[name];
    if(payers.length===0) return null;
    return { ...t, payers, payer:payers[0], ben, payerAmounts, benAmounts };
  }).filter(Boolean);

  const gamble=(currentTripData.gamble||[]).map(g=>{
    const entries = {...(g.entries||{})};
    delete entries[name];
    const transfers = (g.transfers||[]).filter(t=>t.from!==name && t.to!==name);
    return { ...g, entries, transfers };
  });

  const gambleBalance = recomputeGambleBalance(gamble, members);

  await setDoc(doc(db,"trips",currentTripId),{ ...currentTripData, members, tx, gamble, gambleBalance });

  updateTxFilterOptions();
  renderTx();
}

function cleanMapByMembers(map, allowed){
  const out={};
  Object.keys(map||{}).forEach(k=>{
    if(allowed.includes(k)) out[k]=map[k];
  });
  return out;
}

function clearForm(){
  editingTxId = null;
  txFormCard.classList.remove("editing-mode");
  formTitle.textContent = "支出を追加";
  addTxBtn.textContent = "支出を追加";
  clearFormBtn.textContent = "クリア";

  if(txType) txType.value = DEFAULT_TX_TYPE;
  txDesc.value = "";
  txAmount.value = "";
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; cb.dataset.amount = ""; });
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; cb.dataset.amount = ""; });
}

// ===== 個別金額モーダル =====
editBenAmountsBtn?.addEventListener("click", openBenAmountModal);
benModalCloseBtn?.addEventListener("click", ()=> closeModal(benModal));
benModal?.addEventListener("click", (e)=>{ if(e.target === benModal) closeModal(benModal); });
benModalClearBtn?.addEventListener("click", ()=>{ benModalList.querySelectorAll('input[data-name]').forEach(inp=> inp.value = ""); });
benModalSaveBtn?.addEventListener("click", saveBenAmountModal);

editPayerAmountsBtn?.addEventListener("click", openPayerAmountModal);
payModalCloseBtn?.addEventListener("click", ()=> closeModal(payModal));
payModal?.addEventListener("click", (e)=>{ if(e.target === payModal) closeModal(payModal); });
payModalClearBtn?.addEventListener("click", ()=>{ payModalList.querySelectorAll('input[data-name]').forEach(inp=> inp.value = ""); });
payModalSaveBtn?.addEventListener("click", savePayerAmountModal);

function makeAmountRow(name, cur){
  const row = document.createElement("div");
  row.style.display = "grid";
  row.style.gridTemplateColumns = "1fr 160px";
  row.style.gap = "10px";
  row.style.alignItems = "center";

  const left = document.createElement("div");
  left.textContent = name;

  const input = document.createElement("input");
  input.type = "text";
  input.inputMode = "decimal";
  input.placeholder = "空欄=均等割り";
  input.value = cur ? String(cur) : "";
  input.setAttribute("data-name", name);

  row.appendChild(left);
  row.appendChild(input);
  return row;
}

function openBenAmountModal(){
  const checked = [];
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) checked.push(cb); });
  if(checked.length === 0){ alert("『サービスを受けた人』を1人以上チェックしてください"); return; }
  benModalList.innerHTML = "";
  checked.forEach(cb=> benModalList.appendChild(makeAmountRow(cb.value, cb.dataset.amount || "")));
  openModal(benModal);
}
function saveBenAmountModal(){
  benModalList.querySelectorAll('input[data-name]').forEach(inp=>{
    const name = inp.dataset.name;
    const n = toInt(inp.value);
    const cb = Array.from(beneficiariesDiv.querySelectorAll('input[type="checkbox"]')).find(x => x.value === name);
    if(!cb) return;
    cb.dataset.amount = n > 0 ? String(n) : "";
  });
  closeModal(benModal);
}

function openPayerAmountModal(){
  const checked = [];
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) checked.push(cb); });
  if(checked.length === 0){ alert("『支払者』を1人以上チェックしてください"); return; }
  payModalList.innerHTML = "";
  checked.forEach(cb=> payModalList.appendChild(makeAmountRow(cb.value, cb.dataset.amount || "")));
  openModal(payModal);
}
function savePayerAmountModal(){
  payModalList.querySelectorAll('input[data-name]').forEach(inp=>{
    const name = inp.dataset.name;
    const n = toInt(inp.value);
    const cb = Array.from(payersDiv.querySelectorAll('input[type="checkbox"]')).find(x => x.value === name);
    if(!cb) return;
    cb.dataset.amount = n > 0 ? String(n) : "";
  });
  closeModal(payModal);
}

selectAllBenBtn?.addEventListener("click", ()=>{
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.checked = (cb.value !== ECON);
    if(!cb.checked) cb.dataset.amount = "";
  });
});

/* =========================================================
   ★追加：メンバー詳細（円グラフ）ロジック
   - 総支出/総収入：種類別（ギャンブルは「ギャンブル」別枠）
   - ギャンブル除外：支出は恩恵者別、収入は支払者別
   - 円グラフは中央寄せ、横スライド
   ========================================================= */
function initMemberDetailCarousel(){
  if(!mdCarousel || !mdDots) return;

  mdDots.innerHTML = "";
  const slides = Array.from(mdCarousel.querySelectorAll(".slide"));
  slides.forEach((_, i)=>{
    const d = document.createElement("button");
    d.type="button";
    d.className="dot";
    d.dataset.idx=String(i);
    d.addEventListener("click", ()=> scrollToSlide(i));
    mdDots.appendChild(d);
  });

  mdPrevBtn?.addEventListener("click", ()=>{
    const i = getCurrentSlideIndex();
    scrollToSlide(Math.max(0, i-1));
  });
  mdNextBtn?.addEventListener("click", ()=>{
    const i = getCurrentSlideIndex();
    scrollToSlide(Math.min(slides.length-1, i+1));
  });

  mdCarousel.addEventListener("scroll", ()=>{
    updateDots();
  }, { passive:true });

  function scrollToSlide(i){
    const s = slides[i];
    if(!s) return;
    mdCarousel.scrollTo({ left: s.offsetLeft, behavior:"smooth" });
  }

  function getCurrentSlideIndex(){
    const left = mdCarousel.scrollLeft;
    let best = 0;
    let bestDist = Infinity;
    slides.forEach((s,i)=>{
      const d = Math.abs(s.offsetLeft - left);
      if(d < bestDist){ bestDist=d; best=i; }
    });
    return best;
  }

  function updateDots(){
    const i = getCurrentSlideIndex();
    Array.from(mdDots.children).forEach((el, idx)=>{
      el.classList.toggle("active", idx===i);
    });
  }

  // 初期
  requestAnimationFrame(updateDots);
}

function openMemberDetail(member){
  if(!currentTripData) return;
  const members = currentTripData.members || [];
  if(!members.includes(member)) return;

  mdTitle.textContent = `詳細：${member}`;
  // 先頭に戻す
  mdCarousel.scrollTo({ left: 0, behavior:"instant" });

  // データ作成
  const data = buildMemberDetailData(member);

  // 描画
  renderPieBlock(pieExpType, lgExpType, data.expenseByType);
  renderPieBlock(pieIncType, lgIncType, data.incomeByType);
  renderPieBlock(pieExpBen,  lgExpBen,  data.expenseByBeneficiary);
  renderPieBlock(pieIncPayer,lgIncPayer,data.incomeByPayer);

  // dot更新
  requestAnimationFrame(()=>{
    Array.from(mdDots.children).forEach((el, idx)=> el.classList.toggle("active", idx===0));
  });

  openModal(memberDetailModal);
}

function buildMemberDetailData(member){
  const members = currentTripData?.members || [];
  const tx = currentTripData?.tx || [];
  const gamble = currentTripData?.gamble || [];

  // (1) 総支出（種類別・ギャンブル含む）
  //  - ギャンブル：entriesが負 → 絶対値を「ギャンブル」
  //  - 通常支出：その種類の「自分の支払額(paidMe)」を支出
  const expenseByType = {};

  // (2) 総収入（種類別・ギャンブル含む）
  //  - ギャンブル：entriesが正 → そのまま「ギャンブル」
  //  - 通常支出：その種類の「自分が受けた恩恵額(benMe)」を収入
  const incomeByType = {};

  // --- ギャンブル（種類別に「ギャンブル」枠） ---
  let gExp = 0;
  let gInc = 0;
  for(const g of gamble){
    const v = Number(g?.entries?.[member] || 0);
    if(v < 0) gExp += (-v);
    if(v > 0) gInc += v;
  }
  if(gExp > 0) expenseByType["ギャンブル"] = Math.round(gExp);
  if(gInc > 0) incomeByType["ギャンブル"] = Math.round(gInc);

  // --- 通常支出（種類別） ---
  for(const t of tx){
    const type = String(t?.type || "（未設定）");
    const { payerOut, benOut } = computeTxBreakdown(t);

    const paidMe = Number(payerOut?.[member] || 0); // ★その種類の自分の支払額
    const benMe  = Number(benOut?.[member]  || 0); // ★その種類の自分の恩恵額

    if(paidMe > 0){
      expenseByType[type] = Math.round((expenseByType[type] || 0) + paidMe);
    }
    if(benMe > 0){
      incomeByType[type]  = Math.round((incomeByType[type]  || 0) + benMe);
    }
  }

  // (3) 総支出（恩恵者ごと・ギャンブル除く）
  //  - 自分が支払った金額(paidMe)を、恩恵配分(benOut)の比率で恩恵者へ按分して合計
  //    例：総額10000、恩恵A6000/B4000、もし自分が10000払ったなら → A6000/B4000
  const expenseByBeneficiary = {};

  // (4) 総収入（支払者ごと・ギャンブル除く）
  //  - 自分が受けた恩恵額(benMe)を、支払者配分(payerOut)の比率で支払者へ按分して合計
  //    例：総額10000、支払A6000/B4000、もし自分の恩恵が10000なら → A6000/B4000
  const incomeByPayer = {};

  for(const t of tx){
    const { payerOut, benOut, amount } = computeTxBreakdown(t);
    const a = Number(amount || 0);
    if(a <= 0) continue;

    const paidMe = Number(payerOut?.[member] || 0);
    const benMe  = Number(benOut?.[member]  || 0);

    // (3) 支出（恩恵者別）
    if(paidMe > 0){
      const denom = a;
      for(const b of Object.keys(benOut || {})){
        if(!(members.includes(b) || b === ECON)) continue; // ECONも含める（元仕様維持）
        const share = paidMe * (Number(benOut[b] || 0) / denom);
        if(share > 0){
          expenseByBeneficiary[b] = Math.round((expenseByBeneficiary[b] || 0) + share);
        }
      }
    }

    // (4) 収入（支払者別）
    if(benMe > 0){
      const denom = a;
      for(const p of Object.keys(payerOut || {})){
        if(!members.includes(p)) continue;
        const share = Number(payerOut[p] || 0) * (benMe / denom);
        if(share > 0){
          incomeByPayer[p] = Math.round((incomeByPayer[p] || 0) + share);
        }
      }
    }
  }

  return { expenseByType, incomeByType, expenseByBeneficiary, incomeByPayer };
}

function renderPieBlock(canvas, legendEl, dataMap){
  const entries = Object.entries(dataMap || {})
    .map(([k,v])=>[k, Math.round(Number(v||0))])
    .filter(([,v])=>v>0)
    .sort((a,b)=>b[1]-a[1]);

  if(!canvas || !legendEl) return;

  if(entries.length === 0){
    // 空表示
    drawEmptyPie(canvas);
    legendEl.innerHTML = `<div class="muted small" style="padding:8px 2px;">データがありません</div>`;
    return;
  }

  const colors = entries.map((_,i)=> colorByIndex(i, entries.length));
  drawPie(canvas, entries, colors);

  legendEl.innerHTML = "";
  entries.forEach(([name,val], i)=>{
    const row = document.createElement("div");
    row.className="lgRow";
    row.innerHTML = `
      <div class="lgLeft">
        <span class="swatch" style="background:${colors[i]}"></span>
        <span class="lgName">${escapeHtml(name)}</span>
      </div>
      <div class="lgVal">${yen(val)}円</div>
    `;
    legendEl.appendChild(row);
  });
}

function setupHiDPICanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth || 280;
  const cssH = canvas.clientHeight || 280;
  canvas.width  = Math.round(cssW * dpr);
  canvas.height = Math.round(cssH * dpr);
  const ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return { ctx, w: cssW, h: cssH };
}

function drawEmptyPie(canvas){
  const { ctx, w, h } = setupHiDPICanvas(canvas);
  ctx.clearRect(0,0,w,h);

  const cx = w/2, cy = h/2;
  const r = Math.min(w,h)*0.38;

  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.fillStyle = "#121833";
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#223";
  ctx.stroke();

  ctx.fillStyle = "rgba(238,240,246,.75)";
  ctx.font = "14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("No data", cx, cy);
}

function drawPie(canvas, entries, colors){
  const { ctx, w, h } = setupHiDPICanvas(canvas);
  ctx.clearRect(0,0,w,h);

  const total = entries.reduce((a, [,v])=>a+v, 0);
  const cx = w/2, cy = h/2;
  const r = Math.min(w,h)*0.42;

  let start = -Math.PI/2;
  entries.forEach(([_, v], i)=>{
    const ang = (v/total) * Math.PI*2;
    const end = start + ang;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, start, end);
    ctx.closePath();
    ctx.fillStyle = colors[i];
    ctx.fill();

    start = end;
  });

  // 枠線
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#223";
  ctx.stroke();

  // 中抜きで見やすく（ドーナツ風）
  ctx.beginPath();
  ctx.arc(cx, cy, r*0.55, 0, Math.PI*2);
  ctx.fillStyle = "#0f1530";
  ctx.fill();
  ctx.lineWidth = 1.5;
  ctx.strokeStyle = "#223";
  ctx.stroke();
}

function colorByIndex(i, n){
  // 見やすいようにHSLを回す（固定配列より重複しにくい）
  const hue = (i * (360 / Math.max(6, n))) % 360;
  return `hsl(${hue} 70% 55%)`;
}

/* =========================
   ここまでメンバー詳細追加
   ========================= */
</script>

<script type="module">
/* 2つ目のmoduleを避けるため、上のmodule末尾に追記したいが
   元コード維持のため分割はしない。ここでは何もしない。 */
</script>

<script type="module">
/* 互換のため空 */
</script>

<script type="module">
/* 互換のため空 */
</script>

<script type="module">
/* 互換のため空 */
</script>

<script type="module">
/* 互換のため空 */
</script>

<script type="module">
/* 互換のため空 */
</script>

<script type="module">
/* 互換のため空 */
</script>

<!-- NOTE:
  ここから下は、元の <script type="module"> を二重にしないために本来不要ですが、
  あなたの貼り付け環境で自動結合などがある場合に備えて残しています。
  （動作には影響しません）
-->

</body>
</html>