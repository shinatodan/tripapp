<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>旅行清算アプリ</title>
<style>
  * { box-sizing: border-box; }
  :root{--gap:12px;--radius:10px}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.4;margin:0;background:#0b1020;color:#eef0f6}
  header{padding:16px 20px;border-bottom:1px solid #223}
  h1{font-size:20px;margin:0}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  @media(max-width:900px){.wrap{grid-template-columns:1fr}}
  .card{background:#121833;border:1px solid #1e2646;border-radius:var(--radius);padding:16px}
  .card h2{font-size:16px;margin:0 0 8px 0}
  label{display:block;font-size:13px;margin-top:10px;opacity:.9}
  input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2a376a;background:#0f1530;color:#eef0f6;font-size:16px;}
  input[type="checkbox"]{width:auto;margin-right:8px}
  .row{display:flex;gap:var(--gap)}
  .row > *{flex:1}
  .vstack{display:flex;flex-direction:column;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a376a;background:#0f1530;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:13px}
  .chips{margin-top:6px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill.plus{background:#123d28;border:1px solid #1c6b42;color:#a9f3c8}
  .pill.minus{background:#3a1820;border:1px solid #7e3340;color:#ffc7d0}
  table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
  th,td{border-bottom:1px solid #223;padding:8px;text-align:left;vertical-align:top;word-wrap:break-word}
  tfoot td{font-weight:bold}
  .right{text-align:right}
  .muted{opacity:.8}
  .btn{cursor:pointer}
  .btn.secondary{background:#0f1530;border-color:#2a376a}
  .btn.danger{background:#2a0f18;border-color:#6a2a3a}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media(max-width:780px){.grid{grid-template-columns:1fr}}
  .small{font-size:12px}
  /* 編集中のハイライト */
  .editing-mode input { border-color: #4a5c9a; background: #1a2240; }
  .editing-mode #addTxBtn { background: #2a376a; border-color: #4a5c9a; }
</style>
</head>
<body>
<header>
  <h1>旅行清算アプリ</h1>
</header>

<div class="wrap">
  <aside class="card">
    <h2>新規作成</h2>
    <div class="row" style="margin-top:10px">
      <input id="newTripName" placeholder="新しい旅行" />
      <button class="btn" id="createTripBtn">作成</button>
    </div>
    <hr style="border-color:#223;margin:14px 0" />
    
    <h2>旅行選択</h2>
    <select id="tripSelect"></select>
    <button class="btn secondary small" id="renameTripBtn" style="margin-top:8px">旅行名を変更</button>
    
    <hr style="border-color:#223;margin:14px 0" />
    <h2>メンバー</h2>
    <div class="row">
      <input id="memberName" placeholder="名前" />
      <button class="btn" id="addMemberBtn">追加</button>
    </div>
    <div id="members" class="chips"></div>
    <hr style="border-color:#223;margin:14px 0" />
    <button class="btn danger" id="deleteTripBtn" style="margin-top:8px">この旅行を削除</button>
  </aside>

  <main>
    <section class="card" id="txFormCard">
      <h2 id="formTitle">支出を追加</h2>
      <div class="grid">
        <div>
          <label for="txDesc">説明</label>
          <input id="txDesc" placeholder="例：銭湯、宿代、ジュース など" />
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label for="txAmount">金額（円）</label>
          <input id="txAmount" type="text" inputmode="decimal" placeholder="例：6500" />
        </div>
        <div>
          <label>支払者（複数可）</label>
          <div id="payers" class="chips"></div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>サービスを受けた人 <span class="muted small">※ダブルクリック/長押しで金額指定</span></label>
        <div id="beneficiaries" class="chips"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="addTxBtn">支出を追加</button>
        <button class="btn secondary" id="clearFormBtn">入力クリア</button>
      </div>
    </section>

    <section class="card">
      <h2>支出一覧</h2>
      <table id="txTable">
        <thead>
          <tr><th>説明</th><th class="right">金額</th><th>支払者</th><th>恩恵者</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card">
      <h2>結果</h2>
      <table id="resultTable">
        <thead>
          <tr><th>名前</th><th class="right">使用額</th><th class="right">支払額</th><th class="right">勝敗</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, setDoc, updateDoc, deleteDoc, doc,
  onSnapshot, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDgHVdhx0RwTv6PkzBBNgY8Ouis7yRGwlY",
  authDomain: "trip-app-eb508.firebaseapp.com",
  projectId: "trip-app-eb508",
  storageBucket: "trip-app-eb508.firebasestorage.app",
  messagingSenderId: "38650349203",
  appId: "1:38650349203:web:1987ddb1536bca9bbe6f66",
  measurementId: "G-JBSHND42QP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ユーティリティ
const byId=id=>document.getElementById(id);
const yen=n=>Math.round(n||0).toLocaleString();
const escapeHtml=s=>String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
const uuid=()=>crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2));

const newTripName=byId("newTripName");
const createTripBtn=byId("createTripBtn");
const tripSelect = byId("tripSelect");
const renameTripBtn = byId("renameTripBtn");
const memberName=byId("memberName");
const addMemberBtn=byId("addMemberBtn");
const membersDiv=byId("members");
const deleteTripBtn=byId("deleteTripBtn");
const txFormCard=byId("txFormCard");
const formTitle=byId("formTitle");
const txDesc=byId("txDesc");
const txAmount=byId("txAmount");
const payersDiv=byId("payers");
const beneficiariesDiv=byId("beneficiaries");
const addTxBtn=byId("addTxBtn");
const clearFormBtn=byId("clearFormBtn");
const txTableBody=document.querySelector("#txTable tbody");
const resultBody=document.querySelector("#resultTable tbody");

// Firestore 状態
let tripsUnsub=null, currentTripUnsub=null;
let tripsIndex=[], currentTripId=null, currentTripData=null;
let editingTxId = null; // 編集中のID

// 初期化
init();
function init(){
  subscribeTrips();
}
tripSelect?.addEventListener("change", ()=>{
  if(tripSelect.value) selectTrip(tripSelect.value);
});


// 旅行一覧購読
function subscribeTrips(){
  if(tripsUnsub) tripsUnsub();
  const q=query(collection(db,"trips"),orderBy("createdAt","asc"));
  tripsUnsub=onSnapshot(q,snap=>{
    tripsIndex=snap.docs.map(d=>({id:d.id,name:d.data().name||"(無題)"}));
    renderTripSelect();
    if(!currentTripId && tripsIndex[0]) selectTrip(tripsIndex[0].id);
    else if(currentTripId && !tripsIndex.find(t=>t.id===currentTripId)){
      currentTripId=null;
      if(tripsIndex[0]) selectTrip(tripsIndex[0].id);
      else clearMainViews();
    }
  });
}

function renderTripSelect(){
  if(!tripSelect) return;
  const prev = tripSelect.value;
  tripSelect.innerHTML = "";
  tripsIndex.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = t.name || "(無題)";
    tripSelect.appendChild(opt);
  });
  // 現在選択をなるべく維持、なければ先頭
  const target = tripsIndex.find(t=>t.id===currentTripId)?.id
              || tripsIndex.find(t=>t.id===prev)?.id
              || (tripsIndex[0]?.id || "");
  if(target){
    tripSelect.value = target;
    if (!currentTripId || currentTripId !== target) {
      selectTrip(target);
    }
  }
}

function selectTrip(id){
  currentTripId=id;
  clearForm(); // 旅行を切り替えたらフォームクリア
  subscribeCurrentTrip(id);
}

function subscribeCurrentTrip(id){
  if(currentTripUnsub) currentTripUnsub();
  const ref=doc(db,"trips",id);
  currentTripUnsub=onSnapshot(ref,d=>{
    if(!d.exists()){ currentTripData=null; clearMainViews(); return; }
    currentTripData=d.data();
    renderMembers(); renderPayerAndBen(); renderTx(); renderResults();
  });
}

function clearMainViews(){
  membersDiv.innerHTML=""; payersDiv.innerHTML=""; beneficiariesDiv.innerHTML="";
  txTableBody.innerHTML=""; resultBody.innerHTML="";
}

// メンバー表示
function renderMembers(){
  if(!currentTripData) return;
  membersDiv.innerHTML="";
  (currentTripData.members||[]).forEach(m=>{
    const span=document.createElement("span");
    span.className="chip"; span.textContent=m+" ";
    const x=document.createElement("button");
    x.textContent="×"; x.className="btn small"; x.style.width="auto";
    x.onclick=()=> removeMember(m);
    span.appendChild(x);
    membersDiv.appendChild(span);
  });
}

// 支払者・恩恵者（両方ともチップ複数選択）
function renderPayerAndBen(){
  if(!currentTripData) return;
  
  // DOM要素がすでに存在するかチェックして、あれば更新だけする方が良いが
  // 編集モード維持のために今回は「全書き換え後、編集中ならチェックを復元」するアプローチを取る
  // ただし renderPayerAndBen はデータ更新時に呼ばれるため、編集中に他人が更新するとフォームがリセットされるリスクがある。
  // 今回は簡易化のため、編集中(editingTxId != null)の場合は再描画時にフォームの状態を維持するロジックを入れる。

  // フォームの状態を一時保存
  const currentFormState = {
      payers: getChecked(payersDiv),
      bens: [], // {name, amount}
  };
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      if(cb.checked) currentFormState.bens.push({name:cb.value, amount: cb.dataset.amount});
  });

  // 支払者
  payersDiv.innerHTML="";
  (currentTripData.members||[]).forEach(m=>{
    const label=document.createElement("label"); label.className="chip";
    const cb=document.createElement("input"); cb.type="checkbox"; cb.value=m; 
    
    // 状態復元 or 新規
    // 編集中、またはユーザーが入力中の場合は既存のチェックを優先したいが、
    // ここでは「DBデータ変更による再描画」なので、本来はDB正にするべきだが、
    // 入力中のフォームが勝手に変わると困るので、編集中のみ復元を試みる。
    // ※ 簡易実装として、編集中でなければデフォルト(全員OFF/恩恵者は全員ON)にはせず、
    //    clearForm()が明示的に呼ばれたときだけリセットされる挙動にする。
    
    // ここではシンプルに再生成し、あとで必要ならチェックをつける
    cb.checked = false; 

    label.appendChild(cb); label.append(" "+m);
    payersDiv.appendChild(label);
  });

  // 恩恵者
  beneficiariesDiv.innerHTML="";
  (currentTripData.members||[]).forEach(m=>{
    const label=document.createElement("label"); 
    label.className="chip";
    const cb=document.createElement("input"); 
    cb.type="checkbox"; 
    cb.value=m; 
    cb.checked = false; 
    cb.dataset.amount = "";

    // 長押し or ダブルクリックで入力
    let pressTimer=null;
    label.addEventListener("touchstart", ()=>{
      pressTimer=setTimeout(()=> editBenAmount(cb),600); // スマホ長押し
    });
    label.addEventListener("touchend", ()=> clearTimeout(pressTimer));
    label.addEventListener("dblclick", ()=> editBenAmount(cb)); // PCダブルクリック

    label.appendChild(cb); 
    label.append(" "+m);
    beneficiariesDiv.appendChild(label);
  });
  
  // フォームの状態を復元（編集中 または 入力中）
  // ただし、メンバー削除等で存在しなくなった人は除外される
  restoreFormState(currentFormState);
}

function restoreFormState(state){
    // 支払者
    payersDiv.querySelectorAll('input').forEach(cb=>{
        if(state.payers.includes(cb.value)) cb.checked = true;
    });
    // 恩恵者（初期ロード時は全員ONにしたいが、編集中はstateに従う）
    // stateが空（初期状態）なら全員ONにする
    const isInit = state.payers.length === 0 && state.bens.length === 0 && !editingTxId;
    
    beneficiariesDiv.querySelectorAll('input').forEach(cb=>{
        if(isInit){
            cb.checked = true; 
        } else {
            const match = state.bens.find(b=>b.name === cb.value);
            if(match) {
                cb.checked = true;
                if(match.amount) cb.dataset.amount = match.amount;
            }
        }
    });
}


function editBenAmount(cb){
  const cur = cb.dataset.amount || "";
  const val = prompt(`${cb.value} さんの使用額を入力してください（空欄で均等割り）`, cur);
  if(val===null) return;
  const n = toInt(val);
  cb.dataset.amount = n>0 ? n : "";
}

// 支出一覧
function renderTx(){
  if(!currentTripData) return;
  const tx=(currentTripData.tx||[]);
  txTableBody.innerHTML="";
  tx.forEach(t=>{
    const payers = t.payers && t.payers.length ? t.payers : (t.payer ? [t.payer] : []);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHtml(t.desc||"")}</td>
      <td class="right">${yen(t.amount)}</td>
      <td>${payers.join(", ")}</td>
      <td>${(t.ben||[]).join(", ")}</td>
      <td>
        <div style="display:flex;gap:4px;justify-content:flex-end">
           <button class="btn small secondary" data-edit="${t.id}">編集</button>
           <button class="btn small danger" data-del="${t.id}">削除</button>
        </div>
      </td>
    `;
    txTableBody.appendChild(tr);
  });
  txTableBody.onclick=e=>{
    const delBtn=e.target.closest("button[data-del]");
    if(delBtn) deleteTx(delBtn.dataset.del);
    
    const editBtn=e.target.closest("button[data-edit]");
    if(editBtn) startEditTx(editBtn.dataset.edit);
  };
}

// 結果（支払者が複数の場合は等分）
function renderResults(){
  if(!currentTripData) return;
  const members=currentTripData.members||[];
  const tx=currentTripData.tx||[];
  const fair=Object.fromEntries(members.map(m=>[m,0]));
  const paid=Object.fromEntries(members.map(m=>[m,0]));

  for(const t of tx){
    const amount=Number(t.amount)||0;

    // 支払額の按分
    const payers = (t.payers && t.payers.length) ? t.payers.filter(p=>members.includes(p))
                  : (t.payer ? [t.payer] : []);
    if(payers.length===0) continue;
    const sharePay = amount / payers.length;
    for(const p of payers) paid[p]=(paid[p]||0)+sharePay;

    // 恩恵者の按分
    const ben=(t.ben||[]).filter(b=>members.includes(b));
    if(ben.length){
      let sumFixed=0;
      let fixedTargets=[];
      for(const b of ben){
        const val=t.benAmounts?.[b];
        if(val){
          fair[b]=(fair[b]||0)+val;
          sumFixed+=val;
          fixedTargets.push(b);
        }
      }
      // 残りを均等割り
      const remain=amount - sumFixed;
      const others=ben.filter(b=>!fixedTargets.includes(b));
      const share=others.length ? remain/others.length : 0;
      for(const b of others){
        fair[b]=(fair[b]||0)+share;
      }
    }
  }

  resultBody.innerHTML="";
  members.forEach(m=>{
    const f=Math.round(fair[m]||0);
    const p=Math.round(paid[m]||0);
    const d=f-p; // 支払った額 - 使うべき額 = 受け取る額(+) / 払う額(-)
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${m}</td>
      <td class="right">${yen(f)}</td>
      <td class="right">${yen(p)}</td>
      <td class="right"><span class="pill ${d>=0?"plus":"minus"}">${d>=0?"+":""}${yen(d)}</span></td>`;
    resultBody.appendChild(tr);
  });
}

// ===== 操作系 =====
createTripBtn.addEventListener("click", async ()=>{
  const name=(newTripName.value||"").trim()||"新しい旅行";
  const ref = await addDoc(collection(db,"trips"),{
    name, members:[], tx:[], createdAt:serverTimestamp()
  });
  selectTrip(ref.id);
  newTripName.value="";
});

// 旅行名変更
renameTripBtn.addEventListener("click", async ()=>{
    if(!currentTripId || !currentTripData) return;
    const curName = currentTripData.name || "";
    const newName = prompt("新しい旅行名を入力してください", curName);
    if(newName && newName !== curName) {
        await updateDoc(doc(db, "trips", currentTripId), { name: newName });
    }
});

addMemberBtn.addEventListener("click", async ()=>{
  if(!currentTripData || !currentTripId) return;
  const m=(memberName.value||"").trim();
  if(!m) return;
  const members=[...(currentTripData.members||[])];
  if(members.includes(m)) { memberName.value=""; return; }
  members.push(m);
  await setDoc(doc(db,"trips",currentTripId),{
    ...currentTripData,
    members,
    tx: (currentTripData.tx||[]).map(t=>({
      ...t,
      ben: (t.ben||[]).filter(b=>members.includes(b)),
      payers: (t.payers|| (t.payer?[t.payer]:[])).filter(p=>members.includes(p))
    }))
  });
  memberName.value="";
});

deleteTripBtn.addEventListener("click", async ()=>{
  if(!currentTripId) return;
  if(!confirm("本当にこの旅行を削除しますか？")) return;
  await deleteDoc(doc(db,"trips",currentTripId));
  currentTripId=null; currentTripData=null;
  clearMainViews();
});

addTxBtn.addEventListener("click", async ()=>{
  if(!currentTripData || !currentTripId) return;
  const desc=(txDesc.value||"").trim();
  const amount = toInt(txAmount.value);
  const payers = getChecked(payersDiv);

  // 恩恵者チェック
  const ben = [];
  const benAmounts = {};
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked){
      ben.push(cb.value);
      if(cb.dataset.amount){
        benAmounts[cb.value] = toInt(cb.dataset.amount);
      }
    }
  });

  if(!amount){ alert("金額は1円以上で入力してください"); return; }
  if(payers.length===0){ alert("支払者を1人以上選んでください"); return; }
  if(ben.length===0){ alert("恩恵者を1人以上選んでください"); return; }

  let newTxList = [...(currentTripData.tx||[])];
  
  const txObj = { 
      id: editingTxId || uuid(), 
      desc, 
      amount, 
      payers, 
      payer:payers[0], // 後方互換
      ben, 
      benAmounts 
  };

  if(editingTxId) {
      // 更新
      const idx = newTxList.findIndex(t => t.id === editingTxId);
      if(idx !== -1) {
          newTxList[idx] = txObj;
      } else {
          newTxList.push(txObj);
      }
  } else {
      // 新規
      newTxList.push(txObj);
  }

  await updateDoc(doc(db,"trips",currentTripId),{ tx: newTxList });
  clearForm();
});


clearFormBtn.addEventListener("click", clearForm);

async function deleteTx(id){
  if(!currentTripData || !currentTripId) return;
  if(!confirm("この支出を削除しますか？")) return;
  const tx=(currentTripData.tx||[]).filter(t=>t.id!==id);
  // もし編集中だったら編集モード解除
  if(editingTxId === id) clearForm();
  await updateDoc(doc(db,"trips",currentTripId),{ tx });
}

// 支出編集モード開始
function startEditTx(id) {
    if(!currentTripData) return;
    const t = (currentTripData.tx||[]).find(x => x.id === id);
    if(!t) return;
    
    editingTxId = id;
    txFormCard.classList.add("editing-mode");
    formTitle.textContent = "支出を編集";
    addTxBtn.textContent = "支出を更新";
    clearFormBtn.textContent = "キャンセル";

    // フォームに値をセット
    txDesc.value = t.desc || "";
    txAmount.value = t.amount;
    
    // 支払者
    const payers = t.payers || (t.payer ? [t.payer] : []);
    payersDiv.querySelectorAll('input').forEach(cb => {
        cb.checked = payers.includes(cb.value);
    });

    // 恩恵者
    const bens = t.ben || [];
    const benAmounts = t.benAmounts || {};
    beneficiariesDiv.querySelectorAll('input').forEach(cb => {
        const isTarget = bens.includes(cb.value);
        cb.checked = isTarget;
        if(isTarget && benAmounts[cb.value]) {
            cb.dataset.amount = benAmounts[cb.value];
        } else {
            cb.dataset.amount = "";
        }
    });

    // スクロールしてフォームを見せる
    txFormCard.scrollIntoView({ behavior: "smooth" });
}

// メンバー削除
async function removeMember(name){
  if(!currentTripData || !currentTripId) return;
  if(!confirm(`${name} をメンバーから削除しますか？`)) return;
  const members=(currentTripData.members||[]).filter(m=>m!==name);
  const tx=(currentTripData.tx||[]).map(t=>{
    const payers = (t.payers || (t.payer?[t.payer]:[])).filter(p=>p!==name);
    const ben = (t.ben||[]).filter(b=>b!==name);
    // 支払者がいなくなった取引は安全のため削除
    if(payers.length===0) return null;
    return { ...t, payers, payer:payers[0], ben };
  }).filter(Boolean);
  await setDoc(doc(db,"trips",currentTripId),{ ...currentTripData, members, tx });
}

// ヘルパ
function getChecked(container){
  const arr=[];
  container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if(cb.checked) arr.push(cb.value);
  });
  // メンバーから消えている人は除外
  return arr.filter(n=> (currentTripData.members||[]).includes(n));
}
function toInt(v){
  if(v==null) return 0;
  const n = String(v).replace(/[^\d-]/g,"");
  return Number.parseInt(n,10) || 0;
}
function clearForm(){
  editingTxId = null;
  txFormCard.classList.remove("editing-mode");
  formTitle.textContent = "支出を追加";
  addTxBtn.textContent = "支出を追加";
  clearFormBtn.textContent = "入力クリア";

  // 入力欄をリセット
  txDesc.value = "";
  txAmount.value = "";

  // 支払者は全員オフ
  payersDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

  // 恩恵者は全員オン、個別金額クリア
  beneficiariesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.checked = true;
      cb.dataset.amount = "";
  });
}

</script>
</body>
</html>
