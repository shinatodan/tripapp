<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ—…è¡Œæ¸…ç®—ã‚¢ãƒ—ãƒªï¼ˆFirestore å…±æœ‰ç‰ˆï¼‰</title>
<style>
  * { box-sizing: border-box; }
  :root{--gap:12px;--radius:10px}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.4;margin:0;background:#0b1020;color:#eef0f6}
  header{padding:16px 20px;border-bottom:1px solid #223}
  h1{font-size:20px;margin:0}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  @media(max-width:900px){.wrap{grid-template-columns:1fr}}
  .card{background:#121833;border:1px solid #1e2646;border-radius:var(--radius);padding:16px}
  .card h2{font-size:16px;margin:0 0 8px 0}
  label{display:block;font-size:13px;margin-top:10px;opacity:.9}
  input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2a376a;background:#0f1530;color:#eef0f6}
  input[type="checkbox"]{width:auto;margin-right:8px}
  .row{display:flex;gap:var(--gap)}
  .row > *{flex:1}
  .vstack{display:flex;flex-direction:column;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a376a;background:#0f1530;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:13px}
  .chips{margin-top:6px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill.plus{background:#123d28;border:1px solid #1c6b42;color:#a9f3c8}
  .pill.minus{background:#3a1820;border:1px solid #7e3340;color:#ffc7d0}
  table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
  th,td{border-bottom:1px solid #223;padding:8px;text-align:left;vertical-align:top;word-wrap:break-word}
  tfoot td{font-weight:bold}
  .right{text-align:right}
  .muted{opacity:.8}
  .btn{cursor:pointer}
  .btn.secondary{background:#0f1530;border-color:#2a376a}
  .btn.danger{background:#2a0f18;border-color:#6a2a3a}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media(max-width:780px){.grid{grid-template-columns:1fr}}
  .small{font-size:12px}

  .calc-wrap{display:grid;grid-template-columns:1fr 240px;gap:14px;align-items:start}
  @media(max-width:1024px){.calc-wrap{grid-template-columns:1fr}}
  .keypad{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .keypad button{padding:12px;border-radius:10px;border:1px solid #2a376a;background:#0f1530;color:#eef0f6;font-size:15px}
  .keypad button.op{background:#101a3e}
  .keypad button.wide{grid-column:span 2}
  .keypad.hidden{display:none}
  #keypad{z-index:1}

  .ghost-btn{display:inline-flex;align-items:center;gap:6px;margin-top:0;padding:6px 10px;border-radius:999px;border:1px dashed #2a376a;background:#0f1530;color:#eef0f6;width:auto}
  .ghost-btn:hover{border-style:solid}
</style>
</head>
<body>
<header>
  <h1>æ—…è¡Œæ¸…ç®—ã‚¢ãƒ—ãƒª</h1>
</header>

<div class="wrap">
  <aside class="card">
    <h2>æ—…è¡Œ</h2>
    <label>æ—¢å­˜æ—…è¡Œé¸æŠ
      <select id="tripSelect"></select>
    </label>
    <div class="row" style="margin-top:10px">
      <input id="newTripName" placeholder="æ–°ã—ã„æ—…è¡Œ" />
      <button class="btn" id="createTripBtn">ä½œæˆ</button>
    </div>
    <hr style="border-color:#223;margin:14px 0" />
    <h2>ãƒ¡ãƒ³ãƒãƒ¼</h2>
    <div class="row">
      <input id="memberName" placeholder="åå‰" />
      <button class="btn" id="addMemberBtn">è¿½åŠ </button>
    </div>
    <div id="members" class="chips"></div>
    <hr style="border-color:#223;margin:14px 0" />
    <button class="btn danger" id="deleteTripBtn" style="margin-top:8px">ã“ã®æ—…è¡Œã‚’å‰Šé™¤</button>
  </aside>

  <main>
    <section class="card">
      <h2>æ”¯å‡ºã‚’è¿½åŠ </h2>

      <div class="grid">
        <div>
          <label for="txDesc">èª¬æ˜</label>
          <input id="txDesc" placeholder="ä¾‹ï¼šéŠ­æ¹¯ã€å®¿ä»£ã€ã‚¸ãƒ¥ãƒ¼ã‚¹ ãªã©" />
        </div>

        <div>
          <label for="txDate">æ—¥ä»˜</label>
          <div class="vstack">
            <input id="txDate" type="date" />
            <button type="button" id="openDatePickerBtn" class="ghost-btn" title="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ã">
              ğŸ“… ä»Šæ—¥: <span id="todayLabel"></span>
            </button>
          </div>
        </div>
      </div>

      <div class="calc-wrap" style="margin-top:10px">
        <div>
          <label for="txAmount">é‡‘é¡ï¼ˆå††ï¼‰</label>
          <input id="txAmount" type="text" inputmode="decimal" placeholder="ä¾‹ï¼š6500" />
        </div>

        <div id="keypad" class="keypad hidden" aria-label="é›»å“">
          <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button class="op" data-k="Ã·">Ã·</button>
          <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button><button class="op" data-k="Ã—">Ã—</button>
          <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button><button class="op" data-k="-">âˆ’</button>
          <button data-k="0">0</button><button data-k="00">00</button><button data-k=".">.</button><button class="op" data-k="+">ï¼‹</button>
          <button class="op" data-k="(">(</button><button class="op" data-k=")">)</button>
          <button class="op wide" data-act="back">âŒ«</button>
          <button class="op" data-act="clear">C</button>
          <button class="op" data-act="equals">=</button>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label for="txPayer">æ”¯æ‰•è€…</label>
          <select id="txPayer"></select>
        </div>
        <div>
          <label>ã‚µãƒ¼ãƒ“ã‚¹ã‚’å—ã‘ãŸäºº</label>
          <div id="beneficiaries" class="chips"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="addTxBtn">æ”¯å‡ºã‚’è¿½åŠ </button>
        <button class="btn secondary" id="clearFormBtn">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
      </div>
    </section>

    <section class="card">
      <h2>æ”¯å‡ºä¸€è¦§</h2>
      <table id="txTable">
        <thead>
          <tr><th>æ—¥ä»˜</th><th>èª¬æ˜</th><th class="right">é‡‘é¡</th><th>æ”¯æ‰•è€…</th><th>æ©æµè€…</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card">
      <h2>çµæœ</h2>
      <table id="resultTable">
        <thead>
          <tr><th>åå‰</th><th class="right">æœ¬æ¥ã®ä½¿ç”¨é¡</th><th class="right">å®Ÿéš›ã®æ”¯æ‰•é¡</th><th class="right">+å‹ã¡ï¼-è² ã‘</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>åˆè¨ˆ</td><td class="right" id="sumFair">0</td><td class="right" id="sumPaid">0</td><td class="right" id="sumDelta">0</td></tr>
        </tfoot>
      </table>
    </section>
  </main>
</div>

<!-- ===== Firebaseï¼ˆESM via CDNï¼‰ ===== -->
<script type="module">
  /* ----------------- Firebase åˆæœŸåŒ– ----------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, setDoc, deleteDoc, doc,
    onSnapshot, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // â˜…ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šï¼ˆãã®ã¾ã¾å·®ã—æ›¿ãˆæ¸ˆã¿ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyDgHVdhx0RwTv6PkzBBNgY8Ouis7yRGwlY",
    authDomain: "trip-app-eb508.firebaseapp.com",
    projectId: "trip-app-eb508",
    storageBucket: "trip-app-eb508.firebasestorage.app",
    messagingSenderId: "38650349203",
    appId: "1:38650349203:web:1987ddb1536bca9bbe6f66",
    measurementId: "G-JBSHND42QP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* ----------------- ã‚¢ãƒ—ãƒªæœ¬ä½“ ----------------- */

  // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const yen = n => (Math.round(n)||0).toLocaleString();
  const byId = id => document.getElementById(id);
  const todayStr = () => new Date().toISOString().slice(0,10);

  function safeEvalToNumber(expr){
    if(typeof expr !== "string") expr = String(expr||"");
    expr = expr.replace(/Ã—/g, "*").replace(/Ã·/g, "/");
    const trimmed = expr.replace(/\s+/g, "");
    if(!trimmed) return NaN;
    if(!/^[0-9+\-*/().]+$/.test(trimmed)) return NaN;
    try{
      const val = Function(`"use strict";return (${trimmed});`)();
      const num = Number(val);
      return Number.isFinite(num) ? Math.round(num) : NaN;
    }catch(e){ return NaN; }
  }
  function pill(v){ const c=v>=0?"plus":"minus"; return `<span class="pill ${c}">${(v>=0?"+":"")}${yen(v)}</span>`; }
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }

  // UIå‚ç…§
  const tripSelect = byId("tripSelect");
  const newTripName = byId("newTripName");
  const createTripBtn = byId("createTripBtn");
  const memberName = byId("memberName");
  const addMemberBtn = byId("addMemberBtn");
  const membersDiv = byId("members");
  const deleteTripBtn = byId("deleteTripBtn");

  const txDesc = byId("txDesc");
  const txDate = byId("txDate");
  const openDatePickerBtn = byId("openDatePickerBtn");
  const todayLabel = byId("todayLabel");

  const txAmount = byId("txAmount");
  const keypad = byId("keypad");
  const txPayer = byId("txPayer");
  const beneficiariesDiv = byId("beneficiaries");
  const addTxBtn = byId("addTxBtn");
  const clearFormBtn = byId("clearFormBtn");

  const txTableBody = document.querySelector("#txTable tbody");
  const resultBody = document.querySelector("#resultTable tbody");
  const sumFair = byId("sumFair"), sumPaid = byId("sumPaid"), sumDelta = byId("sumDelta");

  // Firestore çŠ¶æ…‹
  let tripsUnsub = null;        // tripsä¸€è¦§è³¼èª­ã®è§£é™¤é–¢æ•°
  let currentTripUnsub = null;  // é¸æŠä¸­æ—…è¡Œãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè³¼èª­ã®è§£é™¤é–¢æ•°
  let tripsIndex = [];          // [{id,name,createdAt}] UIç”¨ä¸€è¦§
  let currentTripId = null;     // é¸æŠä¸­ID
  let currentTripData = null;   // {name, members[], tx[]}

  // åˆæœŸåŒ–ï¼šä¸€è¦§è³¼èª­ â†’ æœ€åˆã®æ—…è¡Œã‚’è‡ªå‹•é¸æŠ
  init();

  async function init(){
    todayLabel.textContent = todayStr();
    txDate.value ||= todayStr();
    subscribeTrips();
  }

  function subscribeTrips(){
    if(tripsUnsub) tripsUnsub();

    const q = query(collection(db,"trips"), orderBy("createdAt","asc"));
    tripsUnsub = onSnapshot(q, (snap)=>{
      tripsIndex = snap.docs.map(d=>({
        id: d.id,
        name: d.data().name || "(ç„¡é¡Œ)",
        createdAt: d.data().createdAt?.toDate?.() || null
      }));
      renderTripSelect();

      // åˆå›ã‚„å‰Šé™¤å¾Œãªã©ã§ current æœªé¸æŠãªã‚‰å…ˆé ­ã‚’é¸ã¶
      if(!currentTripId && tripsIndex[0]){
        selectTrip(tripsIndex[0].id);
      }else if(currentTripId && !tripsIndex.find(t=>t.id===currentTripId)){
        // ç¾åœ¨ã®æ—…è¡ŒãŒä¸€è¦§ã‹ã‚‰æ¶ˆãˆãŸï¼ˆå‰Šé™¤ã•ã‚ŒãŸï¼‰â†’å…ˆé ­ã¸
        currentTripId = null;
        if(tripsIndex[0]) selectTrip(tripsIndex[0].id);
        else clearMainViews();
      }
    });
  }

  function clearMainViews(){
    membersDiv.innerHTML = "";
    beneficiariesDiv.innerHTML = "";
    txTableBody.innerHTML = "";
    resultBody.innerHTML = "";
    sumFair.textContent = "0"; sumPaid.textContent = "0"; sumDelta.textContent = "0";
    txPayer.innerHTML = "";
  }

  function renderTripSelect(){
    tripSelect.innerHTML = "";
    tripsIndex.forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      if(t.id===currentTripId) opt.selected = true;
      tripSelect.appendChild(opt);
    });
  }

  function selectTrip(id){
    currentTripId = id;
    tripSelect.value = id;
    subscribeCurrentTrip(id);
  }

  function subscribeCurrentTrip(id){
    if(currentTripUnsub) currentTripUnsub();

    const ref = doc(db,"trips",id);
    currentTripUnsub = onSnapshot(ref, (d)=>{
      if(!d.exists()){
        currentTripData = null;
        clearMainViews();
        return;
      }
      currentTripData = d.data();
      renderMembers();
      renderPayerAndBen();
      renderTx();
      renderResults();
    });
  }

  // --------- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ----------
  function renderMembers(){
    if(!currentTripData) return;
    const members = currentTripData.members || [];
    membersDiv.innerHTML = "";
    members.forEach(m=>{
      const span = document.createElement("span");
      span.className = "chip";
      span.textContent = m;
      const x = document.createElement("button");
      x.textContent = "Ã—"; x.className = "btn small"; x.style.width="auto";
      x.onclick = ()=> removeMember(m);
      span.appendChild(x);
      membersDiv.appendChild(span);
    });
  }

  function renderPayerAndBen(){
    if(!currentTripData) return;
    const members = currentTripData.members || [];
    // æ”¯æ‰•è€…
    txPayer.innerHTML = "";
    members.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m; opt.textContent = m;
      txPayer.appendChild(opt);
    });
    // æ©æµè€…
    beneficiariesDiv.innerHTML = "";
    members.forEach(m=>{
      const label = document.createElement("label");
      label.className = "chip";
      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.value = m; cb.checked = true;
      label.appendChild(cb);
      label.append(" "+m);
      beneficiariesDiv.appendChild(label);
    });
  }

  function renderTx(){
    if(!currentTripData) return;
    const tx = (currentTripData.tx || []).slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
    txTableBody.innerHTML = "";
    tx.forEach(t=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.date||""}</td>
        <td>${escapeHtml(t.desc||"")}</td>
        <td class="right">${yen(t.amount)}</td>
        <td>${t.payer}</td>
        <td>${(t.ben||[]).join(", ")}</td>
        <td><button class="btn small danger" data-del="${t.id}">å‰Šé™¤</button></td>
      `;
      txTableBody.appendChild(tr);
    });
    // å‰Šé™¤ãƒœã‚¿ãƒ³å§”è­²
    txTableBody.onclick = (e)=>{
      const btn = e.target.closest("button[data-del]");
      if(btn) deleteTx(btn.dataset.del);
    };
  }

  function renderResults(){
    if(!currentTripData) return;
    const members = currentTripData.members || [];
    const tx = currentTripData.tx || [];
    const fair = Object.fromEntries(members.map(m=>[m,0]));
    const paid = Object.fromEntries(members.map(m=>[m,0]));
    for(const t of tx){
      const amount = Number(t.amount)||0;
      paid[t.payer] = (paid[t.payer]||0) + amount;
      const ben = (t.ben||[]).filter(b=>members.includes(b));
      const share = ben.length ? amount / ben.length : 0;
      for(const b of ben){ fair[b] = (fair[b]||0) + share; }
    }
    resultBody.innerHTML = "";
    let sFair=0, sPaid=0, sDelta=0;
    members.forEach(m=>{
      const f = Math.round(fair[m]||0);
      const p = Math.round(paid[m]||0);
      const d = f - p;
      sFair+=f; sPaid+=p; sDelta+=d;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m}</td>
        <td class="right">${yen(f)}</td>
        <td class="right">${yen(p)}</td>
        <td class="right">${pill(d)}</td>
      `;
      resultBody.appendChild(tr);
    });
    sumFair.textContent = yen(sFair);
    sumPaid.textContent = yen(sPaid);
    sumDelta.textContent = yen(sDelta);
  }

  // --------- Firestore Write ãƒ˜ãƒ«ãƒ‘ ----------
  async function fsCreateTrip(name){
    const ref = await addDoc(collection(db,"trips"), {
      name: name || "æ–°ã—ã„æ—…è¡Œ",
      members: [],
      tx: [],
      createdAt: serverTimestamp()
    });
    return ref.id;
  }
  async function fsUpdateTrip(partial){
    if(!currentTripId) return;
    const data = {
      ...(currentTripData||{}),
      ...partial
    };
    await setDoc(doc(db,"trips",currentTripId), data, { merge:true });
  }
  async function fsDeleteTrip(id){
    await deleteDoc(doc(db,"trips",id));
  }

  // --------- æ“ä½œ ----------
  createTripBtn.onclick = async ()=>{
    const name = (newTripName.value||"").trim();
    const id = await fsCreateTrip(name);
    newTripName.value = "";
    selectTrip(id);
  };

  tripSelect.onchange = ()=>{
    const id = tripSelect.value;
    selectTrip(id);
  };

  addMemberBtn.onclick = async ()=>{
    if(!currentTripData) return;
    const nm = (memberName.value||"").trim();
    if(!nm) return;
    const members = currentTripData.members || [];
    if(members.includes(nm)) return alert("åŒåãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã™");
    await fsUpdateTrip({ members: [...members, nm] });
    memberName.value="";
  };

  async function removeMember(nm){
    if(!currentTripData) return;
    if(!confirm(nm+" ã‚’ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰å¤–ã—ã¾ã™ã‹ï¼Ÿï¼ˆæ”¯å‡ºã®å±¥æ­´ã¯æ®‹ã‚Šã¾ã™ï¼‰")) return;
    const members = (currentTripData.members||[]).filter(x=>x!==nm);
    // æ—¢å­˜ã®æ”¯å‡ºã® ben/payer ã«æ®‹ã£ã¦ã„ã¦ã‚‚OKï¼ˆå±¥æ­´ã¯æ®‹ã™æ–¹é‡ï¼‰
    await fsUpdateTrip({ members });
  }

  // æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼
  openDatePickerBtn.addEventListener("click", ()=>{
    try{
      if(typeof txDate.showPicker === "function"){ txDate.showPicker(); }
      else { txDate.focus(); }
    }catch(e){ txDate.focus(); }
  });

  // é›»å“ã®è¡¨ç¤ºåˆ¶å¾¡
  function showKeypad(){ keypad.classList.remove("hidden"); }
  function hideKeypad(){ keypad.classList.add("hidden"); }
  txAmount.addEventListener("focus", showKeypad);
  txAmount.addEventListener("input", showKeypad);
  txAmount.addEventListener("keydown", (e)=>{
    if(e.key==="Escape"){ hideKeypad(); }
    if(e.key==="Enter"){ e.preventDefault(); calcAndFill(); }
  });
  document.addEventListener("click", (e)=>{
    const within = e.target.closest("#keypad") || e.target.closest("#txAmount");
    if(!within){ hideKeypad(); }
  });
  document.querySelectorAll("#keypad button[data-k]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      txAmount.value += btn.dataset.k;
      txAmount.focus();
    });
  });
  document.querySelectorAll("#keypad button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.dataset.act;
      if(act==="clear"){ txAmount.value=""; }
      else if(act==="back"){ txAmount.value = txAmount.value.slice(0,-1); }
      else if(act==="equals"){ calcAndFill(); }
      txAmount.focus();
    });
  });
  function calcAndFill(){
    const v = txAmount.value;
    const num = safeEvalToNumber(v);
    if(Number.isNaN(num)){
      alert("å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ä½¿ãˆã‚‹è¨˜å·ï¼š0-9 + - Ã— Ã· * / . ( )");
      return;
    }
    txAmount.value = String(num);
    hideKeypad();
  }

  // æ”¯å‡ºç™»éŒ²
  addTxBtn.onclick = async ()=>{
    if(!currentTripData) return;
    if(!/^\d+$/.test(txAmount.value.trim())){
      calcAndFill();
      if(!/^\d+$/.test(txAmount.value.trim())) return;
    }
    const amount = Number(txAmount.value||0);
    const payer = txPayer.value;
    const ben = Array.from(beneficiariesDiv.querySelectorAll("input[type=checkbox]:checked")).map(x=>x.value);
    if(!amount || amount<=0) return alert("é‡‘é¡ã‚’å…¥ã‚Œã¦ãã ã•ã„");
    if(!payer) return alert("æ”¯æ‰•è€…ã‚’é¸ã‚“ã§ãã ã•ã„");
    if(!ben.length) return alert("ã‚µãƒ¼ãƒ“ã‚¹ã‚’å—ã‘ãŸäººã‚’1äººä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„");

    const tx = currentTripData.tx || [];
    const row = {
      id: crypto.randomUUID(),
      date: txDate.value || todayStr(),
      desc: (txDesc.value||"").trim(),
      amount, payer, ben
    };
    await fsUpdateTrip({ tx: [...tx, row] });

    txDesc.value=""; txAmount.value="";
  };

  // æ”¯å‡ºå‰Šé™¤
  async function deleteTx(id){
    if(!currentTripData) return;
    const row = (currentTripData.tx||[]).find(x=>x.id===id);
    if(!row) return;
    if(!confirm(`ã€Œ${row.desc||""} / ${row.amount}å††ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const next = (currentTripData.tx||[]).filter(x=>x.id!==id);
    await fsUpdateTrip({ tx: next });
  }

  // æ—…è¡Œå‰Šé™¤
  deleteTripBtn.onclick = async ()=>{
    if(!currentTripId) return alert("å‰Šé™¤ã§ãã‚‹æ—…è¡ŒãŒã‚ã‚Šã¾ã›ã‚“");
    const name = tripsIndex.find(t=>t.id===currentTripId)?.name || "(ç„¡é¡Œ)";
    if(!confirm(`æ—…è¡Œã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    await fsDeleteTrip(currentTripId);
    // ä¸€è¦§è³¼èª­ãŒæ›´æ–°ã•ã‚Œã€selectTripã¯ subscribeTrips å´ã§è‡ªå‹•å‡¦ç†
  };

  // å…¥åŠ›ã‚¯ãƒªã‚¢
  clearFormBtn.onclick = ()=>{
    txDesc.value=""; txAmount.value=""; txDate.value=todayStr();
  };

  /* ---- åˆå›ãƒ‡ãƒ¼ã‚¿ï¼ˆç©ºã®å ´åˆã ã‘ï¼‰ã‚’ä½œã‚ŠãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ– ----
  window.addEventListener('load', async ()=>{
    const snap = await getDocs(collection(db,"trips"));
    if(snap.empty){
      const id = await fsCreateTrip("ãƒ‡ãƒ¢ï¼ˆ5äººï¼šA,B,C,D,Eï¼‰");
      // ãƒ‡ãƒ¢ã®ä¸­èº«ã‚’1å›ã ã‘æ›¸ãè¾¼ã‚€
      await setDoc(doc(db,"trips",id), {
        members: ["A","B","C","D","E"],
        tx: [
          {id:crypto.randomUUID(), date: todayStr(), desc:"éŠ­æ¹¯", amount:1300*5, payer:"A", ben:["A","B","C","D","E"]},
          {id:crypto.randomUUID(), date: todayStr(), desc:"å®¿ä»£", amount:50000, payer:"A", ben:["A","B","C","D","E"]},
          {id:crypto.randomUUID(), date: todayStr(), desc:"ã‚¸ãƒ¥ãƒ¼ã‚¹", amount:700*2, payer:"C", ben:["A","B"]},
        ]
      }, { merge:true });
      selectTrip(id);
    }
  });
  */
</script>
</body>
</html>
